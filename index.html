<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delivery Tracker (React)</title>
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", sans-serif;
        background-color: #1c1c1e;
        color: white;
        touch-action: manipulation;
      }
      .parent-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        pointer-events: none;
        z-index: 0;
        background: linear-gradient(
          to right,
          transparent,
          rgba(10, 132, 255, 0.9)
        );
        opacity: 0.2;
        transition: opacity 0.05s linear;
      }

      .parent-loading-overlay.reverse {
        background: linear-gradient(
          to left,
          transparent,
          rgba(10, 132, 255, 0.9)
        );
      }

      .parent-loading-overlay.remove {
        background: linear-gradient(
          to left,
          transparent,
          rgba(255, 59, 48, 0.9)
        );
      }

      .parent-loading-overlay.remove.reverse {
        background: linear-gradient(
          to right,
          transparent,
          rgba(255, 59, 48, 0.9)
        );
      }
      /* Ripple gradient effect for delivery buttons */
      @keyframes ripple-effect {
        0% {
          transform: scale(0);
          opacity: 0.5;
        }
        50% {
          transform: scale(2.5);
          opacity: 0.3;
        }
        100% {
          transform: scale(4);
          opacity: 0;
        }
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #2c2c2e;
        padding: 1rem;
      }
      .button {
        background-color: #0a84ff;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 1rem 2rem;
        font-size: 1.2rem;
        margin: 1rem auto;
        cursor: pointer;
        display: block;
        width: 90%;
        max-width: 300px;
      }
      .danger {
        background-color: #ff3b30;
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: #2c2c2e;
        padding: 1rem;
        border-radius: 10px;
        width: 90%;
        max-width: 400px;
        color: white;
        position: relative;
        z-index: 1001;
      }
      body.modal-open {
        overflow: hidden;
      }
      .hold-btn .progress-ring {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        pointer-events: none;
        z-index: 2;
      }
      .hold-btn .progress-ring circle {
        stroke: white;
        stroke-width: 4;
        fill: none;
        stroke-dasharray: 283;
        stroke-dashoffset: 283;
        transition: stroke-dashoffset 0.05s linear;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- React + Babel CDN -->
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect } = React;

      function App() {
        const [page, setPage] = useState("home");
        const [settings, setSettings] = useState(() => {
          const saved = localStorage.getItem("settings");
          return saved
            ? JSON.parse(saved)
            : {
                hourlyRate: "10", // default value
                perDelivery: "2", // default value
                perExtra: "1", // default value
                perAdditional: "1", // default value
              };
        });

        const [shiftData, setShiftData] = useState(() => {
          const savedShift = JSON.parse(localStorage.getItem("currentShift"));
          return (
            savedShift || {
              startMileage: "",
              isClockedIn: false,
              startTime: null,
              endTime: null,
            }
          );
        });

        useEffect(() => {
          localStorage.setItem("settings", JSON.stringify(settings));
        }, [settings]);

        useEffect(() => {
          if (shiftData.isClockedIn) {
            // Save shift data to localStorage to persist across app restarts
            localStorage.setItem("currentShift", JSON.stringify(shiftData));
          } else {
            localStorage.removeItem("currentShift"); // Clean up if shift ends
          }
        }, [shiftData]);

        return (
          <div>
            <header>
              <div>Delivery Tracker</div>
              <button onClick={() => setPage("settings")} aria-label="Settings">
                ⚙
              </button>
            </header>
            <main>
              {page === "home" && (
                <HomePage
                  setPage={setPage}
                  shiftData={shiftData} // Pass shift data to home page
                />
              )}
              {page === "settings" && (
                <SettingsPage
                  settings={settings}
                  setSettings={setSettings}
                  setPage={setPage}
                />
              )}
              {page === "startShift" && (
                <StartShiftPage
                  setPage={setPage}
                  shiftData={shiftData}
                  setShiftData={setShiftData}
                />
              )}
              {page === "shift" && (
                <ShiftPage
                  settings={settings}
                  shiftData={shiftData}
                  setShiftData={setShiftData}
                  setPage={setPage}
                />
              )}
              {page === "history" && (
                <HistoryPage settings={settings} setPage={setPage} />
              )}
            </main>
          </div>
        );
      }

      function HomePage({ setPage, shiftData }) {
        const handleStartShift = () => {
          // Navigate to start shift page
          setPage("startShift");
        };

        const handleCurrentShift = () => {
          // Navigate to the shift page if a shift is ongoing
          setPage("shift");
        };

        return (
          <main style={{ padding: "1.5rem" }}>
            {shiftData.isClockedIn ? (
              <button className="button" onClick={handleCurrentShift}>
                Current Shift
              </button>
            ) : (
              <button className="button" onClick={handleStartShift}>
                Start Shift
              </button>
            )}

            <button className="button" onClick={() => setPage("history")}>
              History
            </button>
          </main>
        );
      }

      function SettingsPage({ settings, setSettings, setPage }) {
        const [form, setForm] = useState(settings);

        function handleChange(e) {
          const { name, value } = e.target;
          setForm((prev) => ({ ...prev, [name]: value }));
        }

        function handleSave() {
          if (
            !form.hourlyRate ||
            !form.perDelivery ||
            !form.perExtra ||
            !form.perAdditional ||
            !form.lastPayDate // Check if the last pay date is filled
          ) {
            alert("Please complete all fields.");
            return;
          }
          setSettings(form);
          setPage("home");
        }

        return (
          <main style={{ padding: "1.5rem" }}>
            <h3 style={{ textAlign: "center", marginBottom: "1.5rem" }}>
              Settings
            </h3>
            <div
              style={{ display: "flex", flexDirection: "column", gap: "1rem" }}
            >
              {/* Hourly Rate Input */}
              <label
                style={{
                  display: "flex",
                  flexDirection: "column",
                  fontSize: "1rem",
                }}
              >
                Hourly Rate (£)
                <input
                  name="hourlyRate"
                  type="number"
                  value={form.hourlyRate}
                  onChange={handleChange}
                  style={{
                    marginTop: "0.5rem",
                    padding: "0.75rem",
                    borderRadius: "8px",
                    border: "none",
                    background: "#2c2c2e",
                    color: "white",
                    fontSize: "1rem",
                  }}
                />
              </label>

              {/* Per Delivery Input */}
              <label
                style={{
                  display: "flex",
                  flexDirection: "column",
                  fontSize: "1rem",
                }}
              >
                Per Delivery (£)
                <input
                  name="perDelivery"
                  type="number"
                  value={form.perDelivery}
                  onChange={handleChange}
                  style={{
                    marginTop: "0.5rem",
                    padding: "0.75rem",
                    borderRadius: "8px",
                    border: "none",
                    background: "#2c2c2e",
                    color: "white",
                    fontSize: "1rem",
                  }}
                />
              </label>

              {/* Per Extra Input */}
              <label
                style={{
                  display: "flex",
                  flexDirection: "column",
                  fontSize: "1rem",
                }}
              >
                Per Extra (£)
                <input
                  name="perExtra"
                  type="number"
                  value={form.perExtra}
                  onChange={handleChange}
                  style={{
                    marginTop: "0.5rem",
                    padding: "0.75rem",
                    borderRadius: "8px",
                    border: "none",
                    background: "#2c2c2e",
                    color: "white",
                    fontSize: "1rem",
                  }}
                />
              </label>

              {/* Per Additional Input */}
              <label
                style={{
                  display: "flex",
                  flexDirection: "column",
                  fontSize: "1rem",
                }}
              >
                Per Additional (£)
                <input
                  name="perAdditional"
                  type="number"
                  value={form.perAdditional}
                  onChange={handleChange}
                  style={{
                    marginTop: "0.5rem",
                    padding: "0.75rem",
                    borderRadius: "8px",
                    border: "none",
                    background: "#2c2c2e",
                    color: "white",
                    fontSize: "1rem",
                  }}
                />
              </label>

              {/* Last Pay Date Input */}
              <label
                style={{
                  display: "flex",
                  flexDirection: "column",
                  fontSize: "1rem",
                }}
              >
                Last Pay Date
                <input
                  name="lastPayDate"
                  type="date"
                  value={form.lastPayDate}
                  onChange={handleChange}
                  style={{
                    marginTop: "0.5rem",
                    padding: "0.75rem",
                    borderRadius: "8px",
                    border: "none",
                    background: "#2c2c2e",
                    color: "white",
                    fontSize: "1rem",
                  }}
                />
              </label>

              <button className="button" onClick={handleSave}>
                Save Settings
              </button>
              <button className="button" onClick={() => setPage("home")}>
                Back to Home
              </button>
            </div>
          </main>
        );
      }

      function StartShiftPage({ setPage, shiftData, setShiftData }) {
        const [startMileage, setStartMileage] = useState(
          shiftData.startMileage || ""
        );

        // Save the start mileage without starting the shift
        const handleSaveMileage = () => {
          if (!startMileage) {
            alert("Please enter your start mileage.");
            return;
          }

          setShiftData({
            ...shiftData,
            startMileage,
            isClockedIn: false, // Shift not started yet
            startTime: null, // Ensure start time is null until clocked in
          });

          alert("Start mileage saved.");
        };

        // Start the shift by setting the start time and marking the shift as clocked in
        const handleClockIn = () => {
          if (!startMileage) {
            alert("Please enter your start mileage before clocking in.");
            return;
          }

          const startTime = new Date();

          // Once clocked in, save the start time and clock-in status
          setShiftData({
            ...shiftData,
            isClockedIn: true,
            startTime,
          });

          setPage("shift"); // Navigate to shift page after clocking in
        };

        return (
          <main style={{ padding: "1.5rem" }}>
            <h3 style={{ textAlign: "center" }}>Start Shift</h3>

            {/* Input to enter start mileage */}
            <div>
              <label>
                Start Mileage:
                <input
                  type="number"
                  value={startMileage}
                  onChange={(e) => setStartMileage(e.target.value)}
                  style={{
                    marginTop: "0.5rem",
                    padding: "0.75rem",
                    borderRadius: "8px",
                    border: "none",
                    background: "#2c2c2e",
                    color: "white",
                    fontSize: "1rem",
                  }}
                />
              </label>
            </div>

            {/* Button to save start mileage */}
            <button className="button" onClick={handleSaveMileage}>
              Save Start Mileage
            </button>

            {/* Button to clock in and start the shift */}
            <button
              className="button"
              onClick={handleClockIn}
              style={{ marginTop: "1rem" }}
              disabled={!startMileage} // Disable clock-in if no mileage is saved
            >
              Clock In
            </button>
          </main>
        );
      }

      function ShiftPage({ settings, shiftData, setShiftData, setPage }) {
        const [counts, setCounts] = useState({
          standard: shiftData.standard || 0,
          extra: shiftData.extra || 0,
          additional: shiftData.additional || 0,
        });
        // Use deliveryTimes as array of Date objects (for each delivery event)
        const [deliveryTimes, setDeliveryTimes] = useState(() => {
          // Initialize from shiftData.latestDeliveryTimes, converting to Date objects if present
          if (
            shiftData.latestDeliveryTimes &&
            Array.isArray(shiftData.latestDeliveryTimes)
          ) {
            return shiftData.latestDeliveryTimes.map((t) => new Date(t));
          }
          return [];
        });
        // Current time for calculations
        const [currentTime, setCurrentTime] = useState(new Date());
        useEffect(() => {
          const interval = setInterval(() => {
            setCurrentTime(new Date());
          }, 1000);
          return () => clearInterval(interval);
        }, []);
        // Get latest delivery time from deliveryTimes array
        const latestDeliveryTime =
          deliveryTimes.length > 0
            ? deliveryTimes[deliveryTimes.length - 1]
            : null;
        // Calculate time ago string for latest delivery
        const calculateTimeAgo = (time) => {
          if (!time) return "N/A";
          if (!(time instanceof Date) || isNaN(time)) return "N/A";
          const diffInSeconds = Math.floor((currentTime - time) / 1000);
          if (diffInSeconds < 0) return "N/A";
          const hours = Math.floor(diffInSeconds / 3600);
          const minutes = Math.floor((diffInSeconds % 3600) / 60);
          const seconds = diffInSeconds % 60;
          let timeAgo = "";
          if (hours > 0) timeAgo += `${hours} hour${hours !== 1 ? "s" : ""} `;
          if (minutes > 0)
            timeAgo += `${minutes} minute${minutes !== 1 ? "s" : ""} `;
          timeAgo += `${seconds} second${seconds !== 1 ? "s" : ""} ago`;
          return timeAgo;
        };
        const latestDeliveryTimeAgo = latestDeliveryTime
          ? calculateTimeAgo(latestDeliveryTime)
          : "N/A";
        const [startTime] = useState(
          new Date(shiftData.startTime || Date.now())
        );
        const [notes, setNotes] = useState(shiftData.notes || "");
        // Notes modal state
        const [showNotesModal, setShowNotesModal] = useState(false);
        const [editNotes, setEditNotes] = useState(notes);
        const [startMileage, setStartMileage] = useState(
          shiftData.startMileage || ""
        );
        const [currentMileage, setCurrentMileage] = useState(
          shiftData.currentMileage || ""
        );
        const [totalMiles, setTotalMiles] = useState(
          shiftData.totalMiles || null
        );
        // State for modals
        const [showMileageModal, setShowMileageModal] = useState(false);
        const [showEndModal, setShowEndModal] = useState(false);
        useEffect(() => {
          if (shiftData.isClockedIn) {
            localStorage.setItem("currentShift", JSON.stringify(shiftData));
          }
        }, [shiftData]);

        // Modal open/close: Prevent background scroll and proper layering
        useEffect(() => {
          const modalVisible =
            showNotesModal || showMileageModal || showEndModal;
          if (modalVisible) {
            document.body.classList.add("modal-open");
          } else {
            document.body.classList.remove("modal-open");
          }
        }, [showNotesModal, showMileageModal, showEndModal]);
        // Calculate the total delivery earnings
        const deliveryEarnings = (counts) => {
          const perDelivery = parseFloat(settings.perDelivery || 0);
          const perExtra = parseFloat(settings.perExtra || 0);
          const perAdditional = parseFloat(settings.perAdditional || 0);
          return (
            counts.standard * perDelivery +
            counts.extra * perExtra +
            counts.additional * perAdditional
          ).toFixed(2);
        };
        // Calculate wage based on start time and end time (current time for ongoing shifts)
        const calculateWage = () => {
          const secondsElapsed = Math.floor((currentTime - startTime) / 1000);
          const minutesElapsed = Math.floor(secondsElapsed / 60);
          const calculatedWage =
            (minutesElapsed / 60) * parseFloat(settings.hourlyRate || 0);
          return isNaN(calculatedWage) ? 0 : calculatedWage.toFixed(2);
        };
        // Helper function to calculate elapsed time (hours, minutes, seconds)
        const calculateTimeElapsed = () => {
          const secondsElapsed = Math.floor((currentTime - startTime) / 1000);
          const hours = Math.floor(secondsElapsed / 3600);
          const minutes = Math.floor((secondsElapsed % 3600) / 60);
          const seconds = secondsElapsed % 60;
          return { hours, minutes, seconds };
        };
        const { hours, minutes, seconds } = calculateTimeElapsed();
        const validWage = calculateWage();
        const totalDelivery = deliveryEarnings(counts);
        const totalEarned = (
          parseFloat(validWage) + parseFloat(totalDelivery)
        ).toFixed(2);
        // For displaying delivery total in the UI (variable used in JSX)
        const deliveryTotal = totalDelivery;
        // --- Hold-to-trigger state and logic for delivery buttons ---
        const [holdState, setHoldState] = useState({
          isHolding: false,
          timer: null,
          type: null,
          action: null, // 'add' or 'remove'
          progress: 0,
          completed: false,
          gradient: null, // 'add' or 'remove' for animation
          clickX: null,
          clickY: null,
        });
        const holdIntervalRef = React.useRef();
        const holdTimeoutRef = React.useRef();
        // Helper: start holding for a button
        const handleButtonHoldStart = (type, action, event) => {
          // Only allow one hold at a time
          if (holdState.isHolding) return;
          let clickX = null;
          let clickY = null;
          if (
            event &&
            event.currentTarget &&
            event.clientX != null &&
            event.clientY != null
          ) {
            const rect =
              event.currentTarget.parentElement.getBoundingClientRect();
            clickX = event.clientX - rect.left;
            clickY = event.clientY - rect.top;
          }
          setHoldState({
            isHolding: true,
            timer: null,
            type,
            action,
            progress: 0,
            completed: false,
            gradient: null,
            clickX,
            clickY,
          });
          // Animate progress bar (update every 50ms)
          let elapsed = 0;
          holdIntervalRef.current = setInterval(() => {
            elapsed += 50;
            setHoldState((prev) => {
              if (!prev.isHolding) return prev;
              return { ...prev, progress: Math.min(elapsed / 3000, 1) };
            });
          }, 50);
          // After 3 seconds, trigger the action
          holdTimeoutRef.current = setTimeout(() => {
            setHoldState((prev) => ({
              ...prev,
              completed: true,
              isHolding: false,
              progress: 1,
              gradient: action,
            }));
            // Actually adjust the count
            handleAdjust(type, action === "add" ? 1 : -1, true /*fromHold*/);
            setTimeout(() => {
              setHoldState((prev) =>
                prev.gradient === action ? { ...prev, gradient: null } : prev
              );
            }, 700);
          }, 3000);
        };
        // Helper: cancel hold if released early, with reverse animation
        const handleButtonHoldEnd = () => {
          clearInterval(holdIntervalRef.current);
          clearTimeout(holdTimeoutRef.current);

          if (holdState.progress < 1) {
            let reverseProgress = holdState.progress;
            const reverseInterval = setInterval(() => {
              reverseProgress -= 0.05;
              if (reverseProgress <= 0) {
                clearInterval(reverseInterval);
                setHoldState((prev) => ({
                  ...prev,
                  isHolding: false,
                  progress: 0,
                  type: null,
                  action: null,
                  completed: false,
                  reversing: false,
                }));
              } else {
                setHoldState((prev) => ({
                  ...prev,
                  progress: reverseProgress,
                  reversing: true,
                }));
              }
            }, 25);
          } else {
            setHoldState((prev) => ({
              ...prev,
              isHolding: false,
              progress: 0,
              type: null,
              action: null,
              completed: false,
              reversing: false,
            }));
          }
        };
        // --- End hold-to-trigger logic ---
        // Track delivery times for each delivery added/removed
        // Accepts fromHold for skipping confirm dialog on -1
        const handleAdjust = (type, delta, fromHold) => {
          if (delta === -1 && counts[type] > 0 && !fromHold) {
            const confirmRemoval = window.confirm(
              `Are you sure you want to remove one ${type} delivery?`
            );
            if (!confirmRemoval) return;
          }
          const newCounts = {
            ...counts,
            [type]: Math.max(0, counts[type] + delta),
          };
          let newDeliveryTimes;
          if (delta === 1) {
            newDeliveryTimes = [...deliveryTimes, new Date()];
          } else if (delta === -1 && deliveryTimes.length > 0) {
            newDeliveryTimes = deliveryTimes.slice(0, -1);
          } else {
            newDeliveryTimes = deliveryTimes;
          }
          setCounts(newCounts);
          setDeliveryTimes(newDeliveryTimes);
          setShiftData({
            ...shiftData,
            standard: newCounts.standard,
            extra: newCounts.extra,
            additional: newCounts.additional,
            latestDeliveryTimes: newDeliveryTimes,
          });
        };

        const handleMileageUpdate = () => {
          const start = parseFloat(startMileage);
          const current = parseFloat(currentMileage);
          if (!isNaN(start) && !isNaN(current) && current >= start) {
            const milesDriven = (current - start).toFixed(1);
            setTotalMiles(milesDriven);
            setShiftData({
              ...shiftData,
              currentMileage,
              totalMiles: milesDriven,
            });
          } else {
            alert("Please enter valid mileage values (current ≥ start).");
          }
        };

        const finalizeShift = () => {
          const end = new Date();
          const shiftRecord = {
            startTime: startTime.toISOString(),
            endTime: end.toISOString(),
            standard: counts.standard,
            extra: counts.extra,
            additional: counts.additional,
            earned: totalEarned,
            notes: notes || "No notes added.", // Ensure that notes are saved
            miles: totalMiles !== null ? totalMiles : "N/A",
            settings: {
              hourlyRate: settings.hourlyRate,
              perDelivery: settings.perDelivery,
              perExtra: settings.perExtra,
              perAdditional: settings.perAdditional,
            },
            latestDeliveryTime: latestDeliveryTime
              ? latestDeliveryTime.toISOString()
              : "N/A",
          };

          const history = JSON.parse(localStorage.getItem("shifts") || "[]");
          history.push(shiftRecord);
          localStorage.setItem("shifts", JSON.stringify(history));

          // Reset shiftData after saving it to history
          setShiftData({
            startMileage: "",
            isClockedIn: false,
            startTime: null,
            endTime: null,
            standard: 0,
            extra: 0,
            additional: 0,
            notes: "",
            currentMileage: "",
            totalMiles: null,
            latestDeliveryTimes: [],
          });

          setPage("home");
        };

        const handleEndShift = () => {
          if (!currentMileage) {
            alert("Please enter the current mileage before ending the shift.");
            return;
          }
          // Show the mileage modal for confirmation before ending the shift
          setShowMileageModal(true);
        };

        const confirmEndShift = () => {
          setShowMileageModal(false); // Close the mileage modal
          const endTime = new Date();
          setShiftData({
            ...shiftData,
            endTime,
            isClockedIn: false,
          });

          const shiftRecord = {
            ...shiftData,
            endTime,
            standard: counts.standard,
            extra: counts.extra,
            additional: counts.additional,
            earned: totalEarned,
            notes: notes || "No notes added.",
            miles: totalMiles !== null ? totalMiles : "N/A",
            settings: {
              hourlyRate: settings.hourlyRate,
              perDelivery: settings.perDelivery,
              perExtra: settings.perExtra,
              perAdditional: settings.perAdditional,
            },
            latestDeliveryTime: latestDeliveryTime
              ? latestDeliveryTime.toISOString()
              : "N/A",
          };

          const shiftHistory = JSON.parse(
            localStorage.getItem("shifts") || "[]"
          );
          shiftHistory.push(shiftRecord);
          localStorage.setItem("shifts", JSON.stringify(shiftHistory));

          // Reset shiftData after ending the shift
          setShiftData({
            startMileage: "",
            isClockedIn: false,
            startTime: null,
            endTime: null,
            standard: 0,
            extra: 0,
            additional: 0,
            notes: "",
            currentMileage: "",
            totalMiles: null,
            latestDeliveryTimes: [],
          });

          setPage("home");
        };

        const cancelEndShift = () => {
          setShowMileageModal(false); // Close the mileage modal without ending the shift
        };

        const handleMileageConfirm = () => {
          if (!currentMileage) {
            alert("Current mileage cannot be empty.");
            return;
          }
          handleMileageUpdate(); // Update mileage first
          setShowEndModal(true); // Show the end shift modal
        };

        return (
          <main style={{ padding: "1.5rem" }}>
            {/* Main Shift Page Content */}
            <section style={{ marginBottom: "1rem" }}>
              <strong>Start Time:</strong> {startTime.toLocaleTimeString()}
            </section>

            <section style={{ marginBottom: "1.5rem" }}>
              <div
                style={{
                  padding: "0.75rem",
                  background: "#2c2c2e",
                  borderRadius: "8px",
                  marginBottom: "1rem",
                }}
              >
                <strong>Duration:</strong> {String(hours).padStart(2, "0")}:
                {String(minutes).padStart(2, "0")}:
                {String(seconds).padStart(2, "0")}
              </div>

              <div
                style={{
                  display: "flex",
                  flexWrap: "wrap",
                  gap: "0.75rem",
                  justifyContent: "space-between",
                }}
              >
                <div
                  style={{
                    flex: "1 1 30%",
                    padding: "0.75rem",
                    background: "#2c2c2e",
                    borderRadius: "8px",
                  }}
                >
                  <strong>Wage:</strong> <br /> £{validWage}
                </div>
                <div
                  style={{
                    flex: "1 1 30%",
                    padding: "0.75rem",
                    background: "#2c2c2e",
                    borderRadius: "8px",
                  }}
                >
                  <strong>Deliveries:</strong> <br /> £{deliveryTotal}
                </div>
                <div
                  style={{
                    flex: "1 1 30%",
                    background: "#2e7d32",
                    color: "white",
                    fontWeight: "bold",
                    textAlign: "center",
                    display: "flex",
                    flexDirection: "column",
                    justifyContent: "center",
                    alignItems: "center",
                    padding: "0.75rem",
                    borderRadius: "8px",
                  }}
                >
                  <strong>Total</strong>
                  <div style={{ fontSize: "1.5rem", marginTop: "0.25rem" }}>
                    £{totalEarned}
                  </div>
                </div>
                {/* Latest Delivery Section: moved after Total Earnings, before Standard Deliveries */}
                <div
                  style={{
                    flex: "1 1 100%",
                    background: "#2c2c2e",
                    borderRadius: "8px",
                    marginTop: "0.75rem",
                    padding: "0.75rem",
                    color: "#fff",
                    fontWeight: "bold",
                  }}
                >
                  <strong>Latest Delivery:</strong>
                  <div
                    style={{
                      marginTop: "0.25rem",
                      fontSize: "1.1rem",
                      fontWeight: "normal",
                      opacity: 0.85,
                    }}
                  >
                    {latestDeliveryTimeAgo}
                  </div>
                </div>
              </div>
            </section>

            {/* Adjust Delivery Counts */}
            <style>
              {`
              .hold-btn {
                position: relative;
                overflow: hidden;
                border: none;
                border-radius: 8px;
                font-size: 1.25rem;
                min-width: 48px;
                padding: 0.5rem 1.2rem;
                color: white;
                cursor: pointer;
                outline: none;
                background-color: #0a84ff;
                z-index: 1;
                perspective: 800px;
                transform-style: preserve-3d;
                transition: transform 0.6s ease, background 0.1s linear, box-shadow 0.15s ease-out;
              }
              .hold-btn.remove {
                background-color: #ff3b30;
              }
              .hold-btn.hold-progress {
                /* Removed transform scaling */
              }
              .hold-btn.pressed {
                box-shadow: 0 0 8px rgba(255, 255, 255, 0.3), 0 2px 10px rgba(0, 0, 0, 0.5);
                transition: box-shadow 0.15s ease-out;
              }
              .hold-btn .progress-bar {
                position: absolute;
                bottom: 0;
                left: 0;
                height: 5px;
                background: linear-gradient(90deg, #0f0, #0a84ff);
                border-radius: 0 0 8px 8px;
                z-index: 2;
                pointer-events: none;
                transition: width 0.05s linear;
              }
              .hold-btn.remove .progress-bar {
                background: linear-gradient(90deg, #ff3b30, #ff9c8c);
              }
              .hold-btn .radial-gradient-effect {
                position: absolute;
                top: 50%; left: 50%;
                width: 300%;
                height: 300%;
                pointer-events: none;
                transform: translate(-50%, -50%);
                border-radius: 50%;
                opacity: 0.6;
                animation: radial-pop 0.7s cubic-bezier(0.22, 1, 0.36, 1) forwards;
                z-index: 5;
              }
              .hold-btn .radial-gradient-effect.add {
                background: radial-gradient(circle, #2fff8a 0%, #0a84ff 80%, transparent 100%);
              }
              .hold-btn .radial-gradient-effect.remove {
                background: radial-gradient(circle, #ff3b30 0%, #ff9c8c 80%, transparent 100%);
              }
              @keyframes radial-pop {
                0% { opacity: 0.7; transform: translate(-50%, -50%) scale(0.7);}
                60% { opacity: 0.8; }
                90% { opacity: 0.3; }
                100% { opacity: 0; transform: translate(-50%, -50%) scale(1.7);}
              }
              `}
            </style>
            <section
              style={{
                display: "flex",
                flexDirection: "column",
                gap: "1rem",
                marginBottom: "1.5rem",
              }}
            >
              {["standard", "extra", "additional"].map((type) => (
                <div
                  key={type}
                  style={{
                    position: "relative",
                    overflow: "hidden",
                    padding: "1rem",
                    background: "#2c2c2e",
                    borderRadius: "8px",
                  }}
                >
                  {holdState.gradient === "add" && holdState.type === type && (
                    <div
                      style={{
                        position: "absolute",
                        top:
                          holdState.clickY != null
                            ? holdState.clickY + "px"
                            : "50%",
                        left:
                          holdState.clickX != null
                            ? holdState.clickX + "px"
                            : "50%",
                        transform: "translate(-50%, -50%)",
                        width: "0",
                        height: "0",
                        borderRadius: "50%",
                        background:
                          "radial-gradient(circle, #2fff8a 0%, transparent 80%)",
                        animation: "ripple-effect 0.7s forwards",
                        pointerEvents: "none",
                        zIndex: 1,
                      }}
                    />
                  )}
                  {holdState.gradient === "remove" &&
                    holdState.type === type && (
                      <div
                        style={{
                          position: "absolute",
                          top:
                            holdState.clickY != null
                              ? holdState.clickY + "px"
                              : "50%",
                          left:
                            holdState.clickX != null
                              ? holdState.clickX + "px"
                              : "50%",
                          transform: "translate(-50%, -50%)",
                          width: "0",
                          height: "0",
                          borderRadius: "50%",
                          background:
                            "radial-gradient(circle, #ff3b30 0%, transparent 80%)",
                          animation: "ripple-effect 0.7s forwards",
                          pointerEvents: "none",
                          zIndex: 1,
                        }}
                      />
                    )}
                  {/* Parent loading overlay */}
                  {holdState.isHolding && holdState.type === type && (
                    <div
                      className={
                        "parent-loading-overlay" +
                        (holdState.action === "remove" ? " remove" : "") +
                        (holdState.reversing ? " reverse" : "")
                      }
                      style={{
                        opacity: holdState.progress,
                        clipPath:
                          holdState.action === "add"
                            ? `inset(0% ${
                                100 - holdState.progress * 100
                              }% 0% 0%)`
                            : `inset(0% 0% 0% ${
                                100 - holdState.progress * 100
                              }%)`,
                      }}
                    />
                  )}
                  <div
                    style={{
                      fontWeight: "bold",
                      textTransform: "capitalize",
                      marginBottom: "0.5rem",
                    }}
                  >
                    {type}
                  </div>
                  <div
                    style={{
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "space-between",
                    }}
                  >
                    {/* Remove button */}
                    <button
                      type="button"
                      className={
                        "hold-btn remove" +
                        (holdState.isHolding &&
                        holdState.type === type &&
                        holdState.action === "remove"
                          ? " hold-progress pressed"
                          : "")
                      }
                      onMouseDown={(e) =>
                        handleButtonHoldStart(type, "remove", e)
                      }
                      onMouseUp={handleButtonHoldEnd}
                      onMouseLeave={handleButtonHoldEnd}
                      onTouchStart={(e) => {
                        e.preventDefault();
                        handleButtonHoldStart(type, "remove", e.touches[0]);
                      }}
                      onTouchEnd={handleButtonHoldEnd}
                      style={{
                        userSelect: "none",
                        WebkitUserSelect: "none",
                        MozUserSelect: "none",
                        msUserSelect: "none",
                      }}
                      aria-label={`Remove ${type} delivery`}
                    >
                      −{/* Radial effect */}
                      {holdState.gradient === "remove" &&
                        holdState.type === type && (
                          <div className="radial-gradient-effect remove" />
                        )}
                    </button>
                    <div style={{ fontSize: "1.5rem" }}>{counts[type]}</div>
                    {/* Add button */}
                    <button
                      type="button"
                      className={
                        "hold-btn" +
                        (holdState.isHolding &&
                        holdState.type === type &&
                        holdState.action === "add"
                          ? " hold-progress pressed"
                          : "")
                      }
                      onMouseDown={(e) => handleButtonHoldStart(type, "add", e)}
                      onMouseUp={handleButtonHoldEnd}
                      onMouseLeave={handleButtonHoldEnd}
                      onTouchStart={(e) => {
                        e.preventDefault();
                        handleButtonHoldStart(type, "add", e.touches[0]);
                      }}
                      onTouchEnd={handleButtonHoldEnd}
                      style={{
                        userSelect: "none",
                        WebkitUserSelect: "none",
                        MozUserSelect: "none",
                        msUserSelect: "none",
                      }}
                      aria-label={`Add ${type} delivery`}
                    >
                      ＋{/* Radial effect */}
                      {holdState.gradient === "add" &&
                        holdState.type === type && (
                          <div className="radial-gradient-effect add" />
                        )}
                    </button>
                  </div>
                  <div
                    style={{
                      fontSize: "0.92rem",
                      color: "#bbb",
                      marginTop: "0.35rem",
                      fontStyle: "italic",
                      textAlign: "center",
                    }}
                  >
                    Hold for 3 seconds to{" "}
                    {type === "standard" ? "add/remove" : "adjust"} deliveries.
                  </div>
                </div>
              ))}
            </section>

            {/* Mileage Tracker */}
            <section
              style={{
                background: "#2c2c2e",
                borderRadius: "12px",
                padding: "1.25rem",
                marginBottom: "2rem",
                boxShadow: "0 1px 4px rgba(0,0,0,0.3)",
              }}
            >
              <h3 style={{ textAlign: "center", marginBottom: "1.5rem" }}>
                Mileage Tracker
              </h3>

              <div
                style={{
                  display: "flex",
                  gap: "1rem",
                  marginBottom: "1rem",
                  flexWrap: "wrap",
                }}
              >
                <div style={{ flex: 1 }}>
                  <label
                    style={{
                      color: "#bbb",
                      fontSize: "0.9rem",
                      marginBottom: "0.25rem",
                      display: "block",
                    }}
                  >
                    Start
                  </label>
                  <input
                    type="number"
                    placeholder="e.g. 12000"
                    value={startMileage}
                    onChange={(e) => setStartMileage(e.target.value)}
                    style={{
                      width: "85%",
                      padding: "0.75rem",
                      fontSize: "1rem",
                      borderRadius: "10px",
                      border: "none",
                      background: "#1c1c1e",
                      color: "white",
                    }}
                  />
                </div>

                <div style={{ flex: 1 }}>
                  <label
                    style={{
                      color: "#bbb",
                      fontSize: "0.9rem",
                      marginBottom: "0.25rem",
                      display: "block",
                    }}
                  >
                    Current
                  </label>
                  <input
                    type="number"
                    placeholder="e.g. 12047.5"
                    value={currentMileage}
                    onChange={(e) => setCurrentMileage(e.target.value)}
                    style={{
                      width: "85%",
                      padding: "0.75rem",
                      fontSize: "1rem",
                      borderRadius: "10px",
                      border: "none",
                      background: "#1c1c1e",
                      color: "white",
                    }}
                  />
                </div>
              </div>

              <button
                onClick={handleMileageUpdate}
                style={{
                  display: "block",
                  width: "100%",
                  padding: "0.75rem",
                  borderRadius: "10px",
                  backgroundColor: "#0a84ff",
                  color: "white",
                  fontSize: "1rem",
                  border: "none",
                  cursor: "pointer",
                  marginBottom: totalMiles !== null ? "1rem" : "0",
                }}
              >
                Update Mileage
              </button>

              {totalMiles !== null && (
                <div
                  style={{
                    marginTop: "0.5rem",
                    background: "#3a3a3c",
                    borderRadius: "8px",
                    padding: "1rem",
                    textAlign: "center",
                    fontSize: "1.2rem",
                    fontWeight: "bold",
                    color: "lightgreen",
                  }}
                >
                  Total Miles Driven: {totalMiles} mi
                </div>
              )}
            </section>

            {/* End Shift Button */}
            <button
              onClick={handleEndShift}
              className="button danger"
              style={{
                marginTop: "1.5rem",
              }}
            >
              End Shift
            </button>

            {/* Back to Home Button */}
            <button
              onClick={() => setPage("home")}
              className="button"
              style={{
                marginTop: "1.5rem",
              }}
            >
              Back to Home
            </button>

            {/* Mileage Modal */}
            {showMileageModal && (
              <div className="modal">
                <div
                  className="modal-content"
                  style={{ padding: "2rem", textAlign: "center" }}
                >
                  <h2 style={{ marginBottom: "1rem", fontSize: "1.5rem" }}>
                    Confirm Mileage
                  </h2>
                  <p
                    style={{
                      fontSize: "1.2rem",
                      color: "#ccc",
                      marginBottom: "2rem",
                    }}
                  >
                    Please confirm your current mileage by entering the latest
                    reading from your car's odometer.
                  </p>
                  <div
                    style={{
                      background: "#1c1c1e",
                      padding: "1rem",
                      borderRadius: "8px",
                      marginBottom: "2rem",
                      fontSize: "1.3rem",
                      color: "white",
                      fontWeight: "bold",
                    }}
                  >
                    Current Mileage: {currentMileage}
                  </div>
                  <div
                    style={{
                      display: "flex",
                      gap: "1rem",
                      justifyContent: "center",
                    }}
                  >
                    <button
                      className="button"
                      onClick={handleMileageConfirm}
                      style={{
                        backgroundColor: "#0a84ff",
                        flex: 1,
                        padding: "0.75rem",
                        fontSize: "1rem",
                      }}
                    >
                      Confirm
                    </button>
                    <button
                      className="button"
                      onClick={cancelEndShift}
                      style={{
                        backgroundColor: "#ff3b30",
                        flex: 1,
                        padding: "0.75rem",
                        fontSize: "1rem",
                      }}
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* End Shift Confirmation Modal */}
            {showEndModal && (
              <div className="modal">
                <div
                  className="modal-content"
                  style={{ maxWidth: "600px", padding: "1rem" }}
                >
                  <h3
                    style={{
                      textAlign: "center",
                      marginBottom: "1.5rem",
                      color: "#fff",
                    }}
                  >
                    End Shift Confirmation
                  </h3>

                  <div
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      marginBottom: "1rem",
                      color: "#fff",
                      fontWeight: "bold",
                    }}
                  >
                    <div>
                      <strong>Start Time:</strong>
                      <div>{startTime.toLocaleTimeString()}</div>
                    </div>
                    <div>
                      <strong>End Time:</strong>
                      <div>{new Date().toLocaleTimeString()}</div>
                    </div>
                  </div>

                  {/* Delivery Counts Section */}
                  <div
                    style={{
                      padding: "1rem",
                      background: "#3a3a3c",
                      borderRadius: "8px",
                      marginBottom: "1rem",
                      boxShadow: "0 1px 4px rgba(0, 0, 0, 0.3)",
                      color: "#fff",
                    }}
                  >
                    <strong>Deliveries Summary:</strong>
                    <div
                      style={{
                        display: "flex",
                        justifyContent: "space-between",
                        marginTop: "1rem",
                      }}
                    >
                      <div>
                        <strong>Standard:</strong> {counts.standard}
                      </div>
                      <div>
                        <strong>Extra:</strong> {counts.extra}
                      </div>
                      <div>
                        <strong>Additional:</strong> {counts.additional}
                      </div>
                    </div>
                  </div>

                  {/* Earnings Section */}
                  <div
                    style={{
                      padding: "1rem",
                      background: "#4CAF50",
                      borderRadius: "8px",
                      marginBottom: "1rem",
                      boxShadow: "0 1px 4px rgba(0, 0, 0, 0.3)",
                      color: "#fff",
                    }}
                  >
                    <strong>Earnings Summary:</strong>
                    <div
                      style={{
                        display: "flex",
                        justifyContent: "space-between",
                        marginTop: "1rem",
                      }}
                    >
                      <div>
                        <strong>Wage:</strong> £{validWage}
                      </div>
                      <div>
                        <strong>Deliveries:</strong> £{deliveryTotal}
                      </div>
                    </div>
                  </div>

                  {/* Total Earnings Section */}
                  <div
                    style={{
                      padding: "1rem",
                      background: "#2c2c2e",
                      borderRadius: "8px",
                      marginBottom: "1rem",
                      boxShadow: "0 1px 4px rgba(0, 0, 0, 0.3)",
                      color: "#fff",
                      fontWeight: "bold",
                    }}
                  >
                    <strong>Total Earnings:</strong>
                    <div
                      style={{
                        fontSize: "1.5rem",
                        color: "lightgreen",
                        textAlign: "center",
                        marginTop: "0.75rem",
                      }}
                    >
                      £{totalEarned}
                    </div>
                  </div>

                  {/* Miles Driven Section */}
                  <div
                    style={{
                      padding: "1rem",
                      background: "#3a3a3c",
                      borderRadius: "8px",
                      marginBottom: "1rem",
                      boxShadow: "0 1px 4px rgba(0, 0, 0, 0.3)",
                      color: "#fff",
                    }}
                  >
                    <strong>Total Miles Driven:</strong>
                    <div
                      style={{
                        fontSize: "1.2rem",
                        fontWeight: "bold",
                        color: "#fff",
                        textAlign: "center",
                        marginTop: "0.75rem",
                      }}
                    >
                      {totalMiles} mi
                    </div>
                  </div>

                  {/* Notes Section */}
                  <div
                    style={{
                      padding: "1rem",
                      background: "#3a3a3c",
                      borderRadius: "8px",
                      marginBottom: "1rem",
                      boxShadow: "0 1px 4px rgba(0, 0, 0, 0.3)",
                      color: "#fff",
                    }}
                  >
                    <strong>Notes:</strong>
                    <div
                      style={{
                        fontSize: "1.2rem",
                        fontWeight: "bold",
                        color: "#fff",
                        textAlign: "center",
                        marginTop: "0.75rem",
                        marginBottom: "0.5rem",
                      }}
                    >
                      {notes || "No notes added."}
                    </div>
                    <button
                      className="button"
                      style={{
                        backgroundColor: "#0a84ff",
                        width: "100%",
                        marginTop: "0.5rem",
                        fontSize: "1rem",
                        padding: "0.5rem",
                      }}
                      onClick={() => {
                        setEditNotes(notes);
                        setShowNotesModal(true);
                      }}
                    >
                      Edit Notes
                    </button>
                  </div>

                  {/* Confirm and Cancel Buttons */}
                  <div
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      gap: "1rem",
                      marginTop: "1rem",
                    }}
                  >
                    <button
                      className="button danger"
                      onClick={confirmEndShift}
                      style={{ flex: 1 }}
                    >
                      Confirm End Shift
                    </button>
                    <button
                      className="button"
                      onClick={() => setShowEndModal(false)}
                      style={{ flex: 1 }}
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Notes Edit Modal */}
            {showNotesModal && (
              <div className="modal">
                <div
                  className="modal-content"
                  style={{
                    maxWidth: "500px",
                    background: "#232325",
                    color: "#fff",
                    borderRadius: "10px",
                  }}
                >
                  <h3 style={{ textAlign: "center", marginBottom: "1rem" }}>
                    Edit Notes
                  </h3>
                  <textarea
                    value={editNotes}
                    onChange={(e) => setEditNotes(e.target.value)}
                    style={{
                      width: "100%",
                      minHeight: "100px",
                      borderRadius: "8px",
                      border: "none",
                      background: "#2c2c2e",
                      color: "#fff",
                      fontSize: "1rem",
                      padding: "0.75rem",
                      marginBottom: "1rem",
                      resize: "vertical",
                    }}
                    placeholder="Add shift notes here..."
                  />
                  <div style={{ display: "flex", gap: "1rem" }}>
                    <button
                      className="button"
                      style={{ flex: 1, backgroundColor: "#0a84ff" }}
                      onClick={() => {
                        setNotes(editNotes);
                        setShowNotesModal(false);
                      }}
                    >
                      Save
                    </button>
                    <button
                      className="button danger"
                      style={{ flex: 1 }}
                      onClick={() => setShowNotesModal(false)}
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            )}
          </main>
        );
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-GB", {
          weekday: "long",
          day: "numeric",
          month: "long",
          year: "numeric",
        });
      }

      function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString("en-GB", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function HistoryPage({ settings, setPage }) {
        const [history, setHistory] = useState([]);
        const [filtered, setFiltered] = useState([]);
        const [showStats, setShowStats] = useState(false);
        const [startDate, setStartDate] = useState("");
        const [endDate, setEndDate] = useState("");

        const [editShift, setEditShift] = useState(null); // Track the shift being edited

        useEffect(() => {
          // Retrieve stored shifts from localStorage
          const stored = JSON.parse(localStorage.getItem("shifts") || "[]");
          setHistory(stored);
          setFiltered(stored);

          // Check if lastPayDate is available in settings
          if (settings.lastPayDate) {
            const [year, month, day] = settings.lastPayDate.split("-"); // Split by "-"
            if (day && month && year) {
              // Format it to yyyy-mm-dd
              const formattedDate = `${year}-${month.padStart(
                2,
                "0"
              )}-${day.padStart(2, "0")}`;
              // Set the start date filter
              setStartDate(formattedDate);
            }
          }
        }, [settings]);

        useEffect(() => {
          handleFilter(); // Trigger the filter whenever startDate or endDate is set
        }, [startDate, endDate]);

        const handleFilter = () => {
          let filteredHistory = history;

          if (startDate) {
            filteredHistory = filteredHistory.filter((shift) => {
              return new Date(shift.startTime) >= new Date(startDate);
            });
          }

          if (endDate) {
            filteredHistory = filteredHistory.filter((shift) => {
              return new Date(shift.endTime) <= new Date(endDate);
            });
          }

          setFiltered(filteredHistory);
        };

        const handleDeleteRecord = (shift) => {
          const confirmDelete = window.confirm(
            `Are you sure you want to delete the shift starting at ${formatTime(
              shift.startTime
            )}?`
          );

          if (confirmDelete) {
            const updatedHistory = history.filter(
              (item) => item.startTime !== shift.startTime
            );

            setHistory(updatedHistory);
            setFiltered(updatedHistory);

            localStorage.setItem("shifts", JSON.stringify(updatedHistory));
          }
        };

        const handleUpdateRecord = (shift) => {
          // Open the modal with the shift data
          setEditShift({ ...shift }); // Copy the shift data into the state for editing
        };

        const handleSaveEdit = () => {
          // Use the shift's saved settings (from editShift.settings), not current settings
          const shiftSettings = editShift.settings || settings;

          // Function to calculate wage based on shift settings (hourly rate)
          function calculateWage(startTime, endTime, shiftSettings) {
            const hourlyRate = parseFloat(shiftSettings.hourlyRate || 0);
            const start = new Date(startTime);
            const end = new Date(endTime);
            const secondsElapsed = Math.floor((end - start) / 1000);
            const minutesElapsed = Math.floor(secondsElapsed / 60);
            const wage = (minutesElapsed / 60) * hourlyRate;
            return isNaN(wage) ? 0 : wage.toFixed(2);
          }

          // Function to calculate delivery earnings based on shift settings
          function deliveryEarnings(shift, shiftSettings) {
            const perDelivery = parseFloat(shiftSettings.perDelivery || 0);
            const perExtra = parseFloat(shiftSettings.perExtra || 0);
            const perAdditional = parseFloat(shiftSettings.perAdditional || 0);
            return (
              (shift.standard || 0) * perDelivery +
              (shift.extra || 0) * perExtra +
              (shift.additional || 0) * perAdditional
            ).toFixed(2);
          }

          // Recalculate wage and delivery earnings based on the shift's settings
          const wage = calculateWage(
            editShift.startTime,
            editShift.endTime,
            shiftSettings
          );
          const dEarnings = deliveryEarnings(editShift, shiftSettings);
          const total = (parseFloat(wage) + parseFloat(dEarnings)).toFixed(2);

          // Update the editShift object with the recalculated totals
          const newEditShift = {
            ...editShift,
            earned: total, // Updated total earnings based on shift settings
            wage: wage, // Updated wage based on shift settings
            deliveryEarnings: dEarnings, // Updated delivery earnings based on shift settings
          };

          // Update the shift record in history with the new values
          const updatedShifts = history.map((shift) =>
            shift.startTime === editShift.startTime ? newEditShift : shift
          );
          setHistory(updatedShifts);
          setFiltered(updatedShifts);
          localStorage.setItem("shifts", JSON.stringify(updatedShifts));
          setEditShift(null); // Close the modal
        };

        const handleCancelEdit = () => {
          setEditShift(null); // Close the modal without saving
        };

        const deliveryEarnings = (shift) => {
          const perDelivery = parseFloat(settings.perDelivery || 0);
          const perExtra = parseFloat(settings.perExtra || 0);
          const perAdditional = parseFloat(settings.perAdditional || 0);
          return (
            (shift.standard || 0) * perDelivery +
            (shift.extra || 0) * perExtra +
            (shift.additional || 0) * perAdditional
          );
        };

        const calculateStats = (data) => {
          const totalShifts = data.length;
          let totalWage = 0;
          let totalDelivery = 0;
          let totalCombined = 0;
          let totalMiles = 0;

          data.forEach((shift) => {
            totalWage += parseFloat(shift.earned);
            totalDelivery += deliveryEarnings(shift);
            totalCombined += parseFloat(shift.earned);
            totalMiles += shift.miles !== "N/A" ? parseFloat(shift.miles) : 0;
          });

          return {
            totalShifts,
            totalWage,
            totalDelivery,
            totalCombined,
            totalMiles,
          };
        };

        const stats = calculateStats(filtered);

        const handleRemoveFilters = () => {
          setStartDate("");
          setEndDate("");
          setFiltered(history); // Show all records again
        };

        const labelStyle = {
          display: "flex",
          flexDirection: "column",
          marginBottom: "1rem",
          color: "#bbb",
          fontSize: "1rem",
        };

        const inputStyle = {
          marginTop: "0.5rem",
          padding: "0.75rem",
          fontSize: "1rem",
          borderRadius: "8px",
          border: "none",
          background: "#2c2c2e",
          color: "white",
        };

        const textareaStyle = {
          ...inputStyle,
          minHeight: "100px",
          resize: "vertical",
        };

        const groupBoxStyle = {
          background: "#3a3a3c",
          borderRadius: "8px",
          padding: "1rem",
          marginBottom: "1rem",
        };

        return (
          <main style={{ padding: "1.5rem", paddingBottom: "80px" }}>
            <h3 style={{ marginBottom: "1.25rem", textAlign: "center" }}>
              Shift History
            </h3>

            {/* Filter Controls */}
            <div
              style={{
                display: "flex",
                gap: "0.75rem",
                marginBottom: "1rem",
                flexWrap: "wrap",
                alignItems: "center",
              }}
            >
              <input
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
                style={{
                  flex: "1 1 140px",
                  padding: "0.5rem",
                  borderRadius: "8px",
                  border: "none",
                  minWidth: "140px",
                }}
              />
              <input
                type="date"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
                style={{
                  flex: "1 1 140px",
                  padding: "0.5rem",
                  borderRadius: "8px",
                  border: "none",
                  minWidth: "140px",
                }}
              />
              <button className="button" onClick={handleRemoveFilters}>
                Remove Filters
              </button>
            </div>

            {/* Stats Panel Toggle */}
            <button
              className="button"
              onClick={() => setShowStats((prev) => !prev)}
              style={{ marginBottom: "1rem" }}
            >
              {showStats ? "Hide Stats" : "Show Stats"}
            </button>

            {/* Stats Panel */}
            {showStats && (
              <div
                style={{
                  display: "flex",
                  flexDirection: "column",
                  gap: "0.75rem",
                  marginBottom: "1.5rem",
                }}
              >
                {[
                  { label: "Total Shifts", value: stats.totalShifts },
                  {
                    label: "Total Wage",
                    value: `£${stats.totalWage.toFixed(2)}`,
                  },
                  {
                    label: "Total Delivery Earnings",
                    value: `£${stats.totalDelivery.toFixed(2)}`,
                  },
                  {
                    label: "Total Combined Earnings",
                    value: `£${stats.totalCombined.toFixed(2)}`,
                  },
                  {
                    label: "Total Miles Driven",
                    value: `${stats.totalMiles.toFixed(1)} mi`,
                  },
                ].map((item, index) => (
                  <div
                    key={index}
                    style={{
                      background: "#2c2c2e",
                      borderRadius: "10px",
                      padding: "1rem",
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "center",
                      boxShadow: "0 1px 4px rgba(0,0,0,0.3)",
                    }}
                  >
                    <span style={{ fontWeight: "600", fontSize: "1rem" }}>
                      {item.label}
                    </span>
                    <span style={{ fontWeight: "bold", fontSize: "1.1rem" }}>
                      {item.value}
                    </span>
                  </div>
                ))}
              </div>
            )}

            {/* Shift Records */}
            {filtered.length === 0 ? (
              <p>No shifts found for the selected range.</p>
            ) : (
              filtered.map((shift, i) => (
                <div
                  key={i}
                  style={{
                    background: "#2c2c2e",
                    borderRadius: "10px",
                    padding: "1.25rem",
                    marginBottom: "1.25rem",
                    boxShadow: "0 1px 3px rgba(0,0,0,0.4)",
                  }}
                >
                  {/* Date & Time */}
                  <div
                    style={{
                      marginBottom: "0.5rem",
                      borderBottom: "1px solid #444",
                      paddingBottom: "0.5rem",
                    }}
                  >
                    <strong>Date:</strong> {formatDate(shift.startTime)}
                    <br />
                    <strong>Start:</strong> {formatTime(shift.startTime)}
                    <br />
                    <strong>End:</strong> {formatTime(shift.endTime)}
                  </div>

                  {/* Delivery Counts */}
                  <div
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      marginBottom: "0.75rem",
                    }}
                  >
                    <div>
                      <strong>Standard:</strong>
                      <br />
                      {shift.standard}
                    </div>
                    <div>
                      <strong>Extra:</strong>
                      <br />
                      {shift.extra}
                    </div>
                    <div>
                      <strong>Additional:</strong>
                      <br />
                      {shift.additional}
                    </div>
                  </div>

                  {/* Earnings */}
                  <div
                    style={{
                      background: "#1f1f1f",
                      borderRadius: "8px",
                      padding: "0.75rem",
                      marginBottom: "0.75rem",
                    }}
                  >
                    <strong>Wage:</strong> £
                    {(
                      parseFloat(shift.earned) - deliveryEarnings(shift)
                    ).toFixed(2)}
                    <br />
                    <strong>Delivery:</strong> £
                    {deliveryEarnings(shift).toFixed(2)}
                    <br />
                    <strong>Total:</strong>{" "}
                    <span style={{ color: "lightgreen", fontWeight: "bold" }}>
                      £{shift.earned}
                    </span>
                  </div>

                  {/* Miles & Notes */}
                  {shift.miles && (
                    <div style={{ marginBottom: "0.5rem" }}>
                      <strong>Miles Driven:</strong> {shift.miles}
                    </div>
                  )}
                  {shift.notes && (
                    <div style={{ fontStyle: "italic", color: "#ccc" }}>
                      <strong>Notes:</strong> {shift.notes}
                    </div>
                  )}
                  {/* Display settings for this shift if present */}
                  {shift.settings && (
                    <div style={{ marginTop: "0.5rem", fontSize: "0.96rem" }}>
                      <div>
                        <strong>Hourly Rate:</strong> £
                        {shift.settings.hourlyRate}
                        <br />
                        <strong>Per Delivery:</strong> £
                        {shift.settings.perDelivery}
                        <br />
                        <strong>Per Extra:</strong> £{shift.settings.perExtra}
                        <br />
                        <strong>Per Additional:</strong> £
                        {shift.settings.perAdditional}
                      </div>
                    </div>
                  )}

                  {/* Action Buttons */}
                  <div
                    style={{ display: "flex", gap: "1rem", marginTop: "1rem" }}
                  >
                    <button
                      className="button"
                      onClick={() => handleUpdateRecord(shift)}
                      style={{ backgroundColor: "#0a84ff" }}
                    >
                      Update
                    </button>
                    <button
                      className="button danger"
                      onClick={() => handleDeleteRecord(shift)}
                    >
                      Delete
                    </button>
                  </div>
                </div>
              ))
            )}

            {editShift && (
              <div className="modal">
                <div
                  className="modal-content"
                  style={{
                    maxWidth: "400px",
                    padding: "1rem",
                    background: "#2c2c2e",
                    borderRadius: "10px",
                    color: "#fff",
                    display: "flex",
                    flexDirection: "column",
                    gap: "1rem",
                  }}
                >
                  <h3
                    style={{
                      textAlign: "center",
                      marginBottom: "0.5rem",
                      fontSize: "1.25rem",
                    }}
                  >
                    Edit Shift
                  </h3>

                  {/* Start Time */}
                  <label
                    style={{
                      display: "flex",
                      flexDirection: "column",
                      marginBottom: "0.5rem",
                      color: "#bbb",
                      fontSize: "0.95rem",
                    }}
                  >
                    Start Time:
                    <input
                      type="datetime-local"
                      value={editShift.startTime.slice(0, 16)}
                      onChange={(e) =>
                        setEditShift({
                          ...editShift,
                          startTime: e.target.value,
                        })
                      }
                      style={{
                        marginTop: "0.3rem",
                        padding: "0.5rem",
                        fontSize: "0.95rem",
                        borderRadius: "6px",
                        border: "none",
                        background: "#2c2c2e",
                        color: "white",
                      }}
                    />
                  </label>

                  {/* End Time */}
                  <label
                    style={{
                      display: "flex",
                      flexDirection: "column",
                      marginBottom: "0.5rem",
                      color: "#bbb",
                      fontSize: "0.95rem",
                    }}
                  >
                    End Time:
                    <input
                      type="datetime-local"
                      value={editShift.endTime.slice(0, 16)}
                      onChange={(e) =>
                        setEditShift({ ...editShift, endTime: e.target.value })
                      }
                      style={{
                        marginTop: "0.3rem",
                        padding: "0.5rem",
                        fontSize: "0.95rem",
                        borderRadius: "6px",
                        border: "none",
                        background: "#2c2c2e",
                        color: "white",
                      }}
                    />
                  </label>

                  {/* Deliveries Group */}
                  <div
                    style={{
                      background: "#3a3a3c",
                      borderRadius: "6px",
                      padding: "0.75rem",
                      marginBottom: "0.75rem",
                    }}
                  >
                    <label
                      style={{
                        display: "flex",
                        flexDirection: "column",
                        marginBottom: "0.5rem",
                        color: "#bbb",
                        fontSize: "0.95rem",
                      }}
                    >
                      Standard Deliveries:
                      <input
                        type="number"
                        value={editShift.standard}
                        onChange={(e) =>
                          setEditShift({
                            ...editShift,
                            standard: Number(e.target.value),
                          })
                        }
                        style={{
                          marginTop: "0.3rem",
                          padding: "0.5rem",
                          fontSize: "0.95rem",
                          borderRadius: "6px",
                          border: "none",
                          background: "#2c2c2e",
                          color: "white",
                        }}
                      />
                    </label>

                    <label
                      style={{
                        display: "flex",
                        flexDirection: "column",
                        marginBottom: "0.5rem",
                        color: "#bbb",
                        fontSize: "0.95rem",
                      }}
                    >
                      Extra Deliveries:
                      <input
                        type="number"
                        value={editShift.extra}
                        onChange={(e) =>
                          setEditShift({
                            ...editShift,
                            extra: Number(e.target.value),
                          })
                        }
                        style={{
                          marginTop: "0.3rem",
                          padding: "0.5rem",
                          fontSize: "0.95rem",
                          borderRadius: "6px",
                          border: "none",
                          background: "#2c2c2e",
                          color: "white",
                        }}
                      />
                    </label>

                    <label
                      style={{
                        display: "flex",
                        flexDirection: "column",
                        marginBottom: "0.5rem",
                        color: "#bbb",
                        fontSize: "0.95rem",
                      }}
                    >
                      Additional Deliveries:
                      <input
                        type="number"
                        value={editShift.additional}
                        onChange={(e) =>
                          setEditShift({
                            ...editShift,
                            additional: Number(e.target.value),
                          })
                        }
                        style={{
                          marginTop: "0.3rem",
                          padding: "0.5rem",
                          fontSize: "0.95rem",
                          borderRadius: "6px",
                          border: "none",
                          background: "#2c2c2e",
                          color: "white",
                        }}
                      />
                    </label>
                  </div>

                  {/* Miles Group */}
                  <div
                    style={{
                      background: "#3a3a3c",
                      borderRadius: "6px",
                      padding: "0.75rem",
                      marginBottom: "0.75rem",
                    }}
                  >
                    <label
                      style={{
                        display: "flex",
                        flexDirection: "column",
                        marginBottom: "0.5rem",
                        color: "#bbb",
                        fontSize: "0.95rem",
                      }}
                    >
                      Miles Driven:
                      <input
                        type="number"
                        value={editShift.miles}
                        onChange={(e) =>
                          setEditShift({ ...editShift, miles: e.target.value })
                        }
                        style={inputStyle}
                      />
                    </label>
                  </div>

                  {/* Notes */}
                  <label style={labelStyle}>
                    Notes:
                    <textarea
                      value={editShift.notes}
                      onChange={(e) =>
                        setEditShift({ ...editShift, notes: e.target.value })
                      }
                      style={textareaStyle}
                    />
                  </label>

                  {/* Buttons */}
                  <div
                    style={{ display: "flex", gap: "1rem", marginTop: "1rem" }}
                  >
                    <button
                      className="button"
                      style={{ flex: 1, background: "#0a84ff" }}
                      onClick={handleSaveEdit}
                    >
                      Save
                    </button>
                    <button
                      className="button"
                      style={{ flex: 1, background: "#ff3b30" }}
                      onClick={handleCancelEdit}
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            )}

            <button
              className="button"
              onClick={() => setPage("home")}
              style={{
                position: "fixed",
                bottom: "20px",
                left: "50%",
                transform: "translateX(-50%)",
                zIndex: "1000", // Ensures the button is above other content
              }}
            >
              Back to Home
            </button>
          </main>
        );
      }

      window.onload = function () {
        ReactDOM.createRoot(document.getElementById("root")).render(<App />);
      };
    </script>
  </body>
</html>
