<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, nofollow" />
    <title>BBVsions — Vision Blind Calculator</title>
    <style>
      :root {
        --bg: #0b0f14;
        --text: #e7eefc;
        --muted: #9fb0cc;
        --line: #223049;
        --accent: #4da3ff;
        --danger: #ff5a6a;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --radius: 14px;
        --pad-lg: 18px;
        --font:
          system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          sans-serif;
        --mono:
          ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: var(--font);
        color: var(--text);
        line-height: 1.35;
        background: radial-gradient(
          1200px 800px at 20% 0%,
          #142037 0%,
          var(--bg) 55%,
          #070a0f 100%
        );
      }
      .hidden {
        display: none !important;
      }
      /* Print-only area (avoids popups/iframes on mobile) */
      #print-area {
        display: none;
      }

      @media print {
        body {
          background: #fff !important;
          color: #000 !important;
        }
        .app,
        .sticky-bar {
          display: none !important;
        }
        #print-area {
          display: block !important;
        }
      }

      body.printing .app,
      body.printing .sticky-bar {
        display: none !important;
      }

      body.printing #print-area {
        display: block !important;
      }
      .app {
        max-width: 1060px;
        margin: 0 auto;
        padding: 18px 14px 92px;
      }
      header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        margin: 8px 0 14px;
      }
      .brand h1 {
        margin: 0;
        font-size: 18px;
        letter-spacing: 0.2px;
      }
      .brand p {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 13px;
      }
      .tabs {
        display: flex;
        gap: 8px;
        padding: 6px;
        border: 1px solid var(--line);
        border-radius: 999px;
        background: rgba(15, 21, 33, 0.55);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: var(--shadow);
      }
      .tab {
        border: 0;
        background: transparent;
        color: var(--muted);
        padding: 10px 14px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        font-size: 13px;
      }
      .tab[aria-selected="true"] {
        color: var(--text);
        background: linear-gradient(
          180deg,
          rgba(77, 163, 255, 0.22),
          rgba(77, 163, 255, 0.1)
        );
        border: 1px solid rgba(77, 163, 255, 0.35);
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border: 1px solid var(--line);
        border-radius: 999px;
        background: rgba(17, 24, 38, 0.55);
        color: var(--muted);
        font-size: 12px;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      .chip strong {
        color: var(--text);
        font-weight: 700;
      }
      .panel {
        margin-top: 14px;
        border: 1px solid var(--line);
        background: linear-gradient(
          180deg,
          rgba(17, 24, 38, 0.72),
          rgba(15, 21, 33, 0.55)
        );
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .panel-hd {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
        padding: var(--pad-lg);
        border-bottom: 1px solid rgba(34, 48, 73, 0.85);
      }
      .panel-hd h2 {
        margin: 0;
        font-size: 15px;
        letter-spacing: 0.2px;
      }
      .panel-hd .sub {
        color: var(--muted);
        font-size: 12px;
        margin-top: 4px;
      }
      .panel-bd {
        padding: var(--pad-lg);
      }
      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .btn {
        border: 1px solid var(--line);
        background: rgba(17, 24, 38, 0.65);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 800;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition:
          transform 0.04s ease,
          border-color 0.15s ease,
          background 0.15s ease;
      }
      .btn:hover {
        border-color: rgba(77, 163, 255, 0.55);
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn.primary {
        background: linear-gradient(
          180deg,
          rgba(77, 163, 255, 0.28),
          rgba(77, 163, 255, 0.14)
        );
        border-color: rgba(77, 163, 255, 0.55);
      }
      .btn.danger {
        background: linear-gradient(
          180deg,
          rgba(255, 90, 106, 0.18),
          rgba(255, 90, 106, 0.08)
        );
        border-color: rgba(255, 90, 106, 0.55);
      }
      .btn.ghost {
        background: transparent;
      }
      .btn.small {
        padding: 8px 10px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 800;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
      }
      .card {
        border: 1px solid rgba(34, 48, 73, 0.85);
        border-radius: var(--radius);
        background: rgba(15, 21, 33, 0.55);
        overflow: hidden;
      }
      .card-hd {
        padding: 12px 14px;
        border-bottom: 1px solid rgba(34, 48, 73, 0.65);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .card-hd h3 {
        margin: 0;
        font-size: 13px;
      }
      .card-bd {
        padding: 12px 14px;
      }
      .muted {
        color: var(--muted);
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
      }
      .err {
        font-size: 12px;
        color: var(--danger);
        margin-top: 6px;
      }
      label {
        display: block;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input,
      select {
        width: 100%;
        padding: 11px 12px;
        border-radius: 12px;
        border: 1px solid rgba(34, 48, 73, 0.9);
        background: rgba(11, 15, 20, 0.55);
        color: var(--text);
        outline: none;
        font-size: 16px;
      }
      input::placeholder {
        color: rgba(159, 176, 204, 0.55);
      }
      input:focus,
      select:focus {
        border-color: rgba(77, 163, 255, 0.65);
        box-shadow: 0 0 0 3px rgba(77, 163, 255, 0.15);
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        border-radius: var(--radius);
        overflow: hidden;
      }
      .table th,
      .table td {
        padding: 10px 10px;
        border-bottom: 1px solid rgba(34, 48, 73, 0.65);
        vertical-align: top;
        text-align: left;
        font-size: 13px;
      }
      .table th {
        color: var(--muted);
        font-weight: 800;
        font-size: 12px;
      }
      .table tr:last-child td {
        border-bottom: none;
      }
      .table .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .pill {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(34, 48, 73, 0.9);
        background: rgba(17, 24, 38, 0.55);
        font-size: 12px;
        color: var(--muted);
      }
      .result-top .pill {
        display: inline-flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
        padding: 10px 12px;
        border-radius: 14px;
        border: 1px solid rgba(77, 163, 255, 0.38);
        background: linear-gradient(
          180deg,
          rgba(77, 163, 255, 0.22),
          rgba(11, 15, 20, 0.08)
        );
        color: rgba(231, 238, 252, 0.92);
        box-shadow:
          0 14px 34px rgba(0, 0, 0, 0.28),
          0 0 0 1px rgba(77, 163, 255, 0.12) inset,
          0 -14px 40px rgba(77, 163, 255, 0.1) inset;
        letter-spacing: 0.2px;
        min-width: 132px;
      }
      .result-top .pill strong {
        display: inline-flex;
        align-items: baseline;
        gap: 6px;
        color: var(--text);
        font-weight: 950;
        font-size: 13px;
        line-height: 1;
      }
      .result-top .pill strong::after {
        content: "";
        display: inline-block;
        width: 18px;
        height: 2px;
        border-radius: 999px;
        background: rgba(77, 163, 255, 0.55);
        margin-left: 6px;
        transform: translateY(-2px);
      }
      .result-top .pill .subpill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 0;
        padding: 5px 9px;
        border-radius: 999px;
        border: 1px solid rgba(34, 48, 73, 0.85);
        background: rgba(11, 15, 20, 0.3);
        color: rgba(159, 176, 204, 0.92);
        font-size: 11px;
        font-weight: 850;
        line-height: 1;
        white-space: nowrap;
      }
      .results {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
        margin-top: 14px;
      }
      .result-card {
        grid-column: span 12;
        position: relative;
        border: 1px solid rgba(77, 163, 255, 0.22);
        border-radius: var(--radius);
        background: linear-gradient(
          180deg,
          rgba(18, 26, 43, 0.88),
          rgba(15, 21, 33, 0.6)
        );
        overflow: hidden;
        box-shadow:
          0 14px 40px rgba(0, 0, 0, 0.45),
          0 0 0 1px rgba(34, 48, 73, 0.5) inset;
      }
      .result-card::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(
          800px 220px at 25% 0%,
          rgba(77, 163, 255, 0.14),
          rgba(77, 163, 255, 0) 60%
        );
      }
      .result-top {
        position: relative;
        padding: 14px 14px 12px 14px;
        border-bottom: 1px solid rgba(34, 48, 73, 0.75);
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
        background: linear-gradient(
          180deg,
          rgba(11, 15, 20, 0.35),
          rgba(11, 15, 20, 0.05)
        );
      }
      .result-top::before {
        content: "";
        position: absolute;
        left: 0;
        top: 10px;
        bottom: 10px;
        width: 3px;
        border-radius: 999px;
        background: rgba(77, 163, 255, 0.75);
      }
      .result-top h3 {
        margin: 0;
        font-size: 14px;
        font-weight: 900;
        letter-spacing: 0.2px;
      }
      .result-meta {
        color: var(--muted);
        font-size: 12px;
        margin-top: 4px;
      }
      .kv {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 10px;
        padding: 12px 14px;
      }
      .k {
        grid-column: span 6;
        border: 1px solid rgba(34, 48, 73, 0.85);
        border-radius: 12px;
        padding: 11px 11px;
        background: linear-gradient(
          180deg,
          rgba(11, 15, 20, 0.44),
          rgba(11, 15, 20, 0.26)
        );
        box-shadow: 0 8px 22px rgba(0, 0, 0, 0.22);
      }
      .k .lbl {
        font-size: 11px;
        color: var(--muted);
      }
      .k .val {
        margin-top: 4px;
        font-size: 16px;
        font-weight: 900;
      }
      .k .val small {
        font-size: 12px;
        color: var(--muted);
        font-weight: 800;
      }
      .k.wide {
        grid-column: span 12;
      }
      .warn {
        padding: 10px 14px;
        border-top: 1px solid rgba(34, 48, 73, 0.65);
        color: rgba(255, 90, 106, 0.95);
        font-size: 12px;
      }
      .sticky-bar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 10px 14px;
        background: linear-gradient(
          180deg,
          rgba(7, 10, 15, 0),
          rgba(7, 10, 15, 0.85) 35%,
          rgba(7, 10, 15, 0.96)
        );
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-top: 1px solid rgba(34, 48, 73, 0.45);
      }
      .sticky-inner {
        max-width: 1060px;
        margin: 0 auto;
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
      }
      .sticky-inner .left {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        color: var(--muted);
        font-size: 12px;
      }
      .hidden {
        display: none !important;
      }
      @media (max-width: 560px) {
        /* Compact sizing row: Blind no. + Width + Drop on one line */
        #job-table-wrap .col-blindno,
        #job-table-wrap .col-width,
        #job-table-wrap .col-drop {
          display: none !important;
        }
        #job-table-wrap .col-compact {
          display: flex !important;
        }
        #job-table-wrap .compact-inputs {
          display: grid;
          grid-template-columns: 1fr 1fr 1fr;
          gap: 8px;
          width: 100%;
        }
        #job-table-wrap .compact-inputs input {
          padding: 11px 10px;
        }
        #job-table-wrap .compact-inputs input::placeholder {
          font-size: 12px;
        }

        /* In-field top labels for compact inputs */
        #job-table-wrap .compact-field {
          position: relative;
        }
        #job-table-wrap .compact-field label {
          position: absolute;
          top: 6px;
          left: 10px;
          font-size: 10px;
          font-weight: 800;
          color: var(--muted);
          pointer-events: none;
        }
        #job-table-wrap .compact-field input {
          padding-top: 20px;
        }
        #job-table-wrap .col-compact::before {
          min-width: 78px;
        }
        .app {
          padding-bottom: 120px;
        }
        header {
          flex-direction: column;
          align-items: stretch;
        }
        .tabs {
          width: 100%;
          justify-content: space-between;
        }
        .panel-hd {
          flex-direction: column;
          align-items: stretch;
        }
        .panel-hd .sub {
          max-width: 100%;
        }
        #job-actions {
          width: 100%;
        }
        #job-actions .btn {
          width: 100%;
          justify-content: center;
        }
        .row {
          gap: 8px;
        }
        .btn {
          padding: 12px 12px;
        }
        .btn.small {
          padding: 10px 10px;
        }
        .card-hd {
          flex-direction: row;
        }
        .sticky-inner {
          flex-direction: column;
          align-items: stretch;
        }
        .sticky-inner .left {
          width: 100%;
          justify-content: space-between;
        }
        .sticky-inner .right {
          width: 100%;
        }
        .sticky-inner .right .btn {
          width: 100%;
          justify-content: center;
          padding: 14px 12px;
        }
        .chip {
          padding: 8px 10px;
        }

        /* Responsive table -> card rows */
        #job-table-wrap .table thead {
          display: none;
        }
        #job-table-wrap .table,
        #job-table-wrap .table tbody,
        #job-table-wrap .table tr,
        #job-table-wrap .table td {
          display: block;
          width: 100%;
        }
        #job-table-wrap .table tr {
          border: 1px solid rgba(34, 48, 73, 0.85);
          border-radius: 14px;
          background: rgba(15, 21, 33, 0.55);
          margin-bottom: 12px;
          position: relative;
        }
        #job-table-wrap .table td {
          border-bottom: 1px solid rgba(34, 48, 73, 0.65);
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 10px;
          padding: 12px;
          overflow: visible;
          min-width: 0;
        }
        #job-table-wrap .table td:last-child {
          border-bottom: none;
        }
        #job-table-wrap .table td::before {
          content: attr(data-label);
          color: var(--muted);
          font-size: 12px;
          font-weight: 800;
          flex: 0 0 auto;
          min-width: 78px;
        }
        #job-table-wrap input,
        #job-table-wrap select {
          flex: 1 1 auto;
          min-width: 0;
          max-width: none;
        }
        #job-table-wrap .actions {
          justify-content: flex-end;
        }
        #job-table-wrap .actions .btn {
          width: auto;
        }
        #job-table-wrap .hint {
          margin-top: 0 !important;
        }
      }
      @media (min-width: 820px) {
        .brand h1 {
          font-size: 20px;
        }
        .k {
          grid-column: span 3;
        }
        .k.wide {
          grid-column: span 6;
        }
        .panel-bd {
          padding: 18px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <div class="brand">
          <h1>BBVsions</h1>
        </div>
        <div class="row" style="justify-content: flex-end">
          <div class="tabs" role="tablist" aria-label="Sections">
            <button
              class="tab"
              id="tab-job"
              role="tab"
              aria-selected="true"
              aria-controls="view-job"
            >
              Job
            </button>
            <button
              class="tab"
              id="tab-settings"
              role="tab"
              aria-selected="false"
              aria-controls="view-settings"
            >
              Settings
            </button>
          </div>
        </div>
      </header>

      <section
        id="view-job"
        class="panel"
        role="tabpanel"
        aria-labelledby="tab-job"
      >
        <div class="panel-hd">
          <div>
            <h2 id="job-heading">Job</h2>
            <div class="sub" id="job-subtext">
              Create a job, then add blinds. Select a material per blind. Click
              Calculate.
            </div>
          </div>
          <div class="row hidden" id="job-actions">
            <button class="btn" id="btn-add-blind" type="button">
              Add Blind
            </button>
            <button class="btn danger" id="btn-clear-job" type="button">
              Clear Blinds
            </button>
            <button class="btn danger" id="btn-new-job" type="button">
              New Job
            </button>
          </div>
        </div>
        <div class="panel-bd">
          <div class="card" id="job-setup-card">
            <div class="card-hd">
              <h3>Job Setup</h3>
              <span class="pill" id="job-pill">No job</span>
            </div>
            <div class="card-bd">
              <div class="grid" id="job-setup">
                <div style="grid-column: span 12">
                  <label for="job-name">Job name</label>
                  <input
                    id="job-name"
                    placeholder="e.g., Smith Street — Living room + Kitchen"
                    autocomplete="off"
                  />
                  <div class="hint">Create a job to enable adding blinds.</div>
                  <div class="err hidden" id="err-job-name"></div>
                </div>
                <div style="grid-column: span 12">
                  <button class="btn primary" id="btn-create-job" type="button">
                    Create Job
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Active job card removed -->

          <div id="job-empty" class="hint">No blinds added yet.</div>
          <div id="job-table-wrap" class="hidden">
            <table class="table" aria-label="Blinds">
              <thead>
                <tr>
                  <th style="width: 12ch">Blind no.</th>
                  <th style="width: 14ch">Width (mm)</th>
                  <th style="width: 14ch">Drop (mm)</th>
                  <th>Material</th>
                  <th style="width: 1%; white-space: nowrap">Actions</th>
                </tr>
              </thead>
              <tbody id="blinds-tbody"></tbody>
            </table>
            <div class="hint" style="margin-top: 10px">
              Rules: Total = drop × 2 + 350; L2 = drop − minus; Pole = width −
              45; Remainder = L2 mod set length.
            </div>
            <div
              class="row hidden"
              id="job-bottom-actions"
              style="margin-top: 12px"
            >
              <button
                class="btn primary"
                id="btn-add-blind-bottom"
                type="button"
              >
                + Add Blind
              </button>
            </div>
          </div>

          <div id="results" class="results hidden" aria-live="polite"></div>
        </div>
      </section>

      <section
        id="view-settings"
        class="panel hidden"
        role="tabpanel"
        aria-labelledby="tab-settings"
      >
        <div class="panel-hd">
          <div>
            <h2>Settings</h2>
            <div class="sub">
              Create and manage Vision materials. Saved locally on this device.
            </div>
          </div>
          <div class="row">
            <button class="btn primary" id="btn-add-material" type="button">
              Add Material
            </button>
            <button class="btn ghost" id="btn-export" type="button">
              Export JSON
            </button>
            <button class="btn ghost" id="btn-import" type="button">
              Import JSON
            </button>
            <button class="btn danger" id="btn-reset-all" type="button">
              Reset All
            </button>
          </div>
        </div>
        <div class="panel-bd">
          <div id="materials-empty" class="hint">
            No materials yet. Add at least one to start calculating jobs.
          </div>

          <div id="materials-table-wrap" class="hidden">
            <table class="table" aria-label="Materials">
              <thead>
                <tr>
                  <th>Name</th>
                  <th style="width: 12ch">Mesh (mm)</th>
                  <th style="width: 12ch">Solid (mm)</th>
                  <th style="width: 12ch">Set (mm)</th>
                  <th style="width: 14ch">L2 minus (mm)</th>
                  <th style="width: 1%; white-space: nowrap">Actions</th>
                </tr>
              </thead>
              <tbody id="materials-tbody"></tbody>
            </table>
          </div>

          <div class="card" style="margin-top: 14px">
            <div class="card-hd">
              <h3 id="mat-form-title">Add Material</h3>
              <span class="pill" id="mat-form-mode">New</span>
            </div>
            <div class="card-bd">
              <form id="material-form">
                <input type="hidden" id="mat-id" />
                <div class="grid">
                  <div style="grid-column: span 12">
                    <label for="mat-name">Material name</label>
                    <input
                      id="mat-name"
                      placeholder="e.g., Grey 50/75"
                      autocomplete="off"
                    />
                    <div class="err hidden" id="err-mat-name"></div>
                  </div>

                  <div style="grid-column: span 6">
                    <label for="mat-mesh">Mesh height (mm)</label>
                    <input
                      id="mat-mesh"
                      inputmode="numeric"
                      placeholder="e.g., 50"
                    />
                    <div class="err hidden" id="err-mat-mesh"></div>
                  </div>

                  <div style="grid-column: span 6">
                    <label for="mat-solid">Solid height (mm)</label>
                    <input
                      id="mat-solid"
                      inputmode="numeric"
                      placeholder="e.g., 75"
                    />
                    <div class="err hidden" id="err-mat-solid"></div>
                  </div>

                  <div style="grid-column: span 6">
                    <label>Set length (mm)</label>
                    <input id="mat-set" disabled placeholder="Auto" />
                  </div>

                  <div style="grid-column: span 6">
                    <label for="mat-minus">L2 minus value (mm)</label>
                    <input
                      id="mat-minus"
                      inputmode="numeric"
                      placeholder="e.g., 25"
                    />
                    <div class="err hidden" id="err-mat-minus"></div>
                  </div>

                  <div style="grid-column: span 12">
                    <div class="row">
                      <button class="btn primary" type="submit">
                        Save Material
                      </button>
                      <button class="btn" id="btn-cancel-edit" type="button">
                        Cancel
                      </button>
                      <span class="hint"
                        >Set length is calculated as mesh + solid.</span
                      >
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <input
            type="file"
            id="import-file"
            accept="application/json"
            class="hidden"
          />
        </div>
      </section>
    </div>

    <div id="print-area" class="hidden" aria-hidden="true"></div>
    <div class="sticky-bar">
      <div class="sticky-inner">
        <div class="left">
          <span class="chip"
            ><strong id="status-materials">0</strong> materials</span
          >
          <span class="chip"><strong id="status-blinds">0</strong> blinds</span>
          <span class="chip"><strong id="status-job">No job</strong></span>
        </div>
        <div class="right">
          <button class="btn primary" id="btn-calc" type="button">
            Calculate
          </button>
        </div>
      </div>
    </div>

    <script>
      (() => {
        const KEYS = {
          materials: "bbvsions_materials_v2",
          blinds: "bbvsions_job_blinds_v2",
          job: "bbvsions_current_job_v1",
        };

        const $ = (s, r = document) => r.querySelector(s);
        const uid = () =>
          crypto?.randomUUID
            ? crypto.randomUUID()
            : "id_" + Math.random().toString(16).slice(2) + Date.now();
        const toInt = (v) => {
          if (typeof v === "number")
            return Number.isFinite(v) ? Math.trunc(v) : NaN;
          const s = String(v ?? "")
            .trim()
            .replace(/,/g, "");
          if (!s) return NaN;
          const n = Number(s);
          return Number.isFinite(n) ? Math.trunc(n) : NaN;
        };
        const fmt = (n) => (Number.isFinite(n) ? String(Math.trunc(n)) : "—");
        const esc = (str) =>
          String(str ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#39;");
        const load = (k, fb) => {
          try {
            const r = localStorage.getItem(k);
            return r ? (JSON.parse(r) ?? fb) : fb;
          } catch {
            return fb;
          }
        };
        const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

        let materials = load(KEYS.materials, []);
        let blinds = load(KEYS.blinds, []);
        let job = load(KEYS.job, null); // {id,name,createdAt}
        let isPrinting = false;

        const digitsOnly = (s) => String(s ?? "").replace(/\D+/g, "");

        const usedBlindNoSet = () =>
          new Set(
            blinds
              .map((b) => digitsOnly(b.blindNo))
              .filter((x) => x.length > 0),
          );

        const nextFreeBlindNo = (start) => {
          let n = Number(start);
          if (!Number.isFinite(n) || n <= 0) n = 1;
          n = Math.trunc(n);
          const used = usedBlindNoSet();
          while (used.has(String(n))) n += 1;
          return String(n);
        };

        const lastAddedBlindNo = () => {
          // last added = last element in the blinds array (append order)
          for (let i = blinds.length - 1; i >= 0; i--) {
            const d = digitsOnly(blinds[i].blindNo);
            const n = Number(d);
            if (d && Number.isFinite(n) && n > 0) return n;
          }
          return NaN;
        };
        const lastSelectedMaterialId = () => {
          for (let i = blinds.length - 1; i >= 0; i--) {
            const mid = String(blinds[i].materialId || "").trim();
            if (mid) return mid;
          }
          return "";
        };

        // Tabs
        const tabJob = $("#tab-job"),
          tabSettings = $("#tab-settings");
        const viewJob = $("#view-job"),
          viewSettings = $("#view-settings");
        const setTab = (which) => {
          const isJob = which === "job";
          tabJob.setAttribute("aria-selected", isJob ? "true" : "false");
          tabSettings.setAttribute("aria-selected", isJob ? "false" : "true");
          viewJob.classList.toggle("hidden", !isJob);
          viewSettings.classList.toggle("hidden", isJob);
          if (!isJob) $("#results").classList.add("hidden");
        };
        tabJob.addEventListener("click", () => setTab("job"));
        tabSettings.addEventListener("click", () => setTab("settings"));

        const renderStatus = () => {
          $("#status-materials").textContent = materials.length;
          $("#status-blinds").textContent = blinds.length;
          $("#status-job").textContent = job?.name ? job.name : "No job";
        };

        // Job gating
        const applyJobState = () => {
          const hasJob = !!job;
          $("#job-setup-card")?.classList.toggle("hidden", hasJob);
          $("#job-actions")?.classList.toggle("hidden", !hasJob);

          $("#job-empty")?.classList.toggle(
            "hidden",
            !hasJob || blinds.length > 0,
          );
          $("#job-table-wrap")?.classList.toggle(
            "hidden",
            !hasJob || !blinds.length,
          );

          $("#job-bottom-actions")?.classList.toggle(
            "hidden",
            !hasJob || blinds.length === 0,
          );

          $("#btn-calc").disabled = !hasJob;

          const title = job?.name || "Job";
          const headingEl = $("#job-heading");
          if (headingEl) headingEl.textContent = title;
          const subEl = $("#job-subtext");
          if (subEl) {
            subEl.textContent = hasJob
              ? "Add blinds, select materials, then tap Calculate."
              : "Create a job, then add blinds. Select a material per blind. Click Calculate.";
          }
        };

        // Create job
        $("#btn-create-job")?.addEventListener("click", () => {
          const nameEl = $("#job-name");
          const errEl = $("#err-job-name");
          if (errEl) {
            errEl.classList.add("hidden");
            errEl.textContent = "";
          }

          const name = String(nameEl?.value || "").trim();
          if (!name) {
            if (errEl) {
              errEl.textContent = "Please enter a job name.";
              errEl.classList.remove("hidden");
            } else alert("Please enter a job name.");
            return;
          }

          job = { id: uid(), name, createdAt: new Date().toISOString() };
          blinds = [];
          save(KEYS.job, job);
          save(KEYS.blinds, blinds);
          $("#results").classList.add("hidden");
          renderJob();
          renderStatus();
          applyJobState();
        });

        // New Job
        $("#btn-new-job")?.addEventListener("click", () => {
          if (
            !confirm(
              "Start a NEW job? This will clear the current job and all blinds.",
            )
          )
            return;
          job = null;
          blinds = [];
          save(KEYS.job, job);
          save(KEYS.blinds, blinds);
          $("#results").classList.add("hidden");
          renderJob();
          renderStatus();
          applyJobState();
          $("#job-name")?.focus();
        });

        // Add blind
        $("#btn-add-blind")?.addEventListener("click", () => {
          if (!job) {
            alert("Create a job first.");
            return;
          }
          const defaultMat = lastSelectedMaterialId() || materials[0]?.id || "";
          const proposed =
            blinds.length === 0
              ? 1
              : Number.isFinite(lastAddedBlindNo())
                ? lastAddedBlindNo() + 1
                : 1;

          blinds.push({
            id: uid(),
            blindNo: nextFreeBlindNo(proposed),
            widthMm: NaN,
            dropMm: NaN,
            materialId: defaultMat,
          });
          save(KEYS.blinds, blinds);
          $("#results").classList.add("hidden");
          renderJob();
          renderStatus();
          applyJobState();
        });
        $("#btn-add-blind-bottom")?.addEventListener("click", () => {
          $("#btn-add-blind")?.click();
        });

        // Clear blinds
        $("#btn-clear-job")?.addEventListener("click", () => {
          if (!job) return;
          if (!blinds.length) return;
          if (!confirm("Clear ALL blinds for this job?")) return;
          blinds = [];
          save(KEYS.blinds, blinds);
          $("#results").classList.add("hidden");
          renderJob();
          renderStatus();
          applyJobState();
        });

        // Settings: Material form + table (CRUD)
        const matForm = $("#material-form");
        const matId = $("#mat-id"),
          matName = $("#mat-name"),
          matMesh = $("#mat-mesh"),
          matSolid = $("#mat-solid"),
          matSet = $("#mat-set"),
          matMinus = $("#mat-minus");
        const matFormTitle = $("#mat-form-title"),
          matFormMode = $("#mat-form-mode");

        const clearMatErrors = () =>
          ["name", "mesh", "solid", "minus"].forEach((k) => {
            const el = $("#err-mat-" + k);
            if (el) {
              el.classList.add("hidden");
              el.textContent = "";
            }
          });
        const showMatError = (field, msg) => {
          const el = $("#err-mat-" + field);
          if (el) {
            el.textContent = msg;
            el.classList.remove("hidden");
          }
        };

        const updateSetPreview = () => {
          const mesh = toInt(matMesh.value),
            solid = toInt(matSolid.value);
          const setLen =
            (Number.isFinite(mesh) ? mesh : 0) +
            (Number.isFinite(solid) ? solid : 0);
          matSet.value = setLen > 0 ? String(setLen) : "";
        };
        matMesh.addEventListener("input", updateSetPreview);
        matSolid.addEventListener("input", updateSetPreview);

        const setMatFormMode = (mode, m = null) => {
          clearMatErrors();
          if (mode === "new") {
            matFormTitle.textContent = "Add Material";
            matFormMode.textContent = "New";
            matId.value = "";
            matName.value = "";
            matMesh.value = "";
            matSolid.value = "";
            matMinus.value = "";
            matSet.value = "";
            matName.focus();
          } else {
            matFormTitle.textContent = "Edit Material";
            matFormMode.textContent = "Editing";
            matId.value = m.id;
            matName.value = m.name;
            matMesh.value = m.meshMm;
            matSolid.value = m.solidMm;
            matMinus.value = m.l2MinusMm;
            matSet.value = (toInt(m.meshMm) || 0) + (toInt(m.solidMm) || 0);
            matName.focus();
          }
        };
        $("#btn-cancel-edit")?.addEventListener("click", () =>
          setMatFormMode("new"),
        );
        $("#btn-add-material")?.addEventListener("click", () => {
          setTab("settings");
          setMatFormMode("new");
          window.scrollTo({ top: 0, behavior: "smooth" });
        });

        const validateMaterial = (c) => {
          clearMatErrors();
          let ok = true;

          const name = String(c.name ?? "").trim();
          const mesh = toInt(c.meshMm),
            solid = toInt(c.solidMm),
            minus = toInt(c.l2MinusMm);

          if (!name) {
            showMatError("name", "Name is required.");
            ok = false;
          } else {
            const key = name.toLowerCase();
            const clash = materials.some(
              (m) =>
                m.id !== c.id && String(m.name).trim().toLowerCase() === key,
            );
            if (clash) {
              showMatError("name", "Name must be unique.");
              ok = false;
            }
          }
          if (!Number.isFinite(mesh) || mesh <= 0) {
            showMatError("mesh", "Mesh must be a positive whole number (mm).");
            ok = false;
          }
          if (!Number.isFinite(solid) || solid <= 0) {
            showMatError(
              "solid",
              "Solid must be a positive whole number (mm).",
            );
            ok = false;
          }
          if (!Number.isFinite(minus) || minus < 0) {
            showMatError("minus", "Minus must be 0 or greater (mm).");
            ok = false;
          }

          return ok;
        };

        matForm?.addEventListener("submit", (e) => {
          e.preventDefault();
          const id = matId.value || uid();
          const c = {
            id,
            name: matName.value.trim(),
            meshMm: toInt(matMesh.value),
            solidMm: toInt(matSolid.value),
            l2MinusMm: toInt(matMinus.value),
          };
          if (!validateMaterial(c)) return;

          const idx = materials.findIndex((m) => m.id === id);
          if (idx >= 0) materials[idx] = c;
          else materials.push(c);

          save(KEYS.materials, materials);
          renderMaterials();
          renderJob();
          renderStatus();
          setMatFormMode("new");
        });

        const renderMaterials = () => {
          const empty = $("#materials-empty"),
            wrap = $("#materials-table-wrap"),
            tbody = $("#materials-tbody");
          if (!tbody) return;
          tbody.innerHTML = "";
          if (!materials.length) {
            empty?.classList.remove("hidden");
            wrap?.classList.add("hidden");
            return;
          }
          empty?.classList.add("hidden");
          wrap?.classList.remove("hidden");

          materials.forEach((m) => {
            const setLen = (toInt(m.meshMm) || 0) + (toInt(m.solidMm) || 0);
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td><strong>${esc(m.name)}</strong></td>
        <td style="font-family:var(--mono)">${esc(String(m.meshMm))}</td>
        <td style="font-family:var(--mono)">${esc(String(m.solidMm))}</td>
        <td style="font-family:var(--mono)">${esc(String(setLen))}</td>
        <td style="font-family:var(--mono)">${esc(String(m.l2MinusMm))}</td>
        <td>
          <div class="actions">
            <button class="btn small" data-action="edit-material" data-id="${m.id}" type="button">Edit</button>
            <button class="btn small danger" data-action="delete-material" data-id="${m.id}" type="button">Delete</button>
          </div>
        </td>`;
            tbody.appendChild(tr);
          });
        };

        $("#materials-tbody")?.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-action]");
          if (!btn) return;
          const action = btn.dataset.action,
            id = btn.dataset.id;
          const m = materials.find((x) => x.id === id);
          if (!m) return;

          if (action === "edit-material") {
            setMatFormMode("edit", m);
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
          if (action === "delete-material") {
            const inUse = blinds.filter((b) => b.materialId === id).length;
            if (inUse > 0) {
              alert(
                `Cannot delete: used by ${inUse} blind(s). Change those blinds first.`,
              );
              return;
            }
            if (!confirm(`Delete material "${m.name}"?`)) return;
            materials = materials.filter((x) => x.id !== id);
            save(KEYS.materials, materials);
            renderMaterials();
            renderJob();
            renderStatus();
          }
        });

        // Export / Import / Reset
        $("#btn-export")?.addEventListener("click", () => {
          const payload = {
            version: 3,
            exportedAt: new Date().toISOString(),
            job,
            materials,
            blinds,
          };
          const blob = new Blob([JSON.stringify(payload, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "bbvsions-export.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });

        const importFile = $("#import-file");
        $("#btn-import")?.addEventListener("click", () => importFile?.click());
        importFile?.addEventListener("change", async () => {
          const file = importFile.files?.[0];
          if (!file) return;
          try {
            const obj = JSON.parse(await file.text());
            if (
              !obj ||
              !Array.isArray(obj.materials) ||
              !Array.isArray(obj.blinds)
            ) {
              alert(
                "Invalid JSON. Expected { materials: [], blinds: [] } (and optional job).",
              );
              return;
            }
            materials = obj.materials
              .map((m) => ({
                id: m.id || uid(),
                name: String(m.name ?? "").trim(),
                meshMm: toInt(m.meshMm),
                solidMm: toInt(m.solidMm),
                l2MinusMm: toInt(m.l2MinusMm),
              }))
              .filter(
                (m) =>
                  m.name &&
                  Number.isFinite(m.meshMm) &&
                  m.meshMm > 0 &&
                  Number.isFinite(m.solidMm) &&
                  m.solidMm > 0 &&
                  Number.isFinite(m.l2MinusMm) &&
                  m.l2MinusMm >= 0,
              );

            blinds = obj.blinds.map((b) => ({
              id: b.id || uid(),
              blindNo: String(b.blindNo ?? "").trim(),
              widthMm: toInt(b.widthMm),
              dropMm: toInt(b.dropMm),
              materialId: String(b.materialId ?? ""),
            }));

            job =
              obj.job && typeof obj.job === "object"
                ? {
                    id: String(obj.job.id || uid()),
                    name: String(obj.job.name || "Untitled job"),
                    createdAt: obj.job.createdAt || new Date().toISOString(),
                  }
                : null;

            save(KEYS.materials, materials);
            save(KEYS.blinds, blinds);
            save(KEYS.job, job);

            $("#results").classList.add("hidden");
            renderMaterials();
            renderJob();
            renderStatus();
            applyJobState();
            setTab("job");
            alert("Import complete.");
          } catch (err) {
            alert("Import failed: " + err.message);
          } finally {
            importFile.value = "";
          }
        });

        $("#btn-reset-all")?.addEventListener("click", () => {
          if (!confirm("Reset ALL saved materials and jobs on this device?"))
            return;
          job = null;
          materials = [];
          blinds = [];
          save(KEYS.job, job);
          save(KEYS.materials, materials);
          save(KEYS.blinds, blinds);
          $("#results").classList.add("hidden");
          renderMaterials();
          renderJob();
          renderStatus();
          applyJobState();
          setMatFormMode("new");
          setTab("settings");
        });

        // Job table CRUD
        const blindsTbody = $("#blinds-tbody");

        const renderJob = () => {
          const empty = $("#job-empty"),
            wrap = $("#job-table-wrap");
          if (!blindsTbody) return;
          blindsTbody.innerHTML = "";
          if (!job) {
            empty?.classList.add("hidden");
            wrap?.classList.add("hidden");
            return;
          }

          if (!blinds.length) {
            empty?.classList.remove("hidden");
            wrap?.classList.add("hidden");
            return;
          }
          empty?.classList.add("hidden");
          wrap?.classList.remove("hidden");

          const options = materials
            .map((m) => {
              const setLen = (toInt(m.meshMm) || 0) + (toInt(m.solidMm) || 0);
              return `<option value="${m.id}">${esc(m.name)} (set ${setLen})</option>`;
            })
            .join("");

          blinds.forEach((b, idx) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td class="col-compact" data-label="Dimensions">
          <div class="compact-inputs">
            <div class="compact-field">
              <label>No.</label>
              <input inputmode="numeric" pattern="[0-9]*" data-field="blindNo" data-id="${b.id}" value="${esc(b.blindNo || "")}">
            </div>
            <div class="compact-field">
              <label>Width</label>
              <input inputmode="numeric" data-field="widthMm" data-id="${b.id}" value="${Number.isFinite(b.widthMm) ? b.widthMm : ""}">
            </div>
            <div class="compact-field">
              <label>Drop</label>
              <input inputmode="numeric" data-field="dropMm" data-id="${b.id}" value="${Number.isFinite(b.dropMm) ? b.dropMm : ""}">
            </div>
          </div>
        </td>

        <td class="col-blindno" data-label="Blind no."><input inputmode="numeric" pattern="[0-9]*" data-field="blindNo" data-id="${b.id}" value="${esc(b.blindNo || "")}" placeholder="e.g., 7"></td>
        <td class="col-width" data-label="Width (mm)"><input inputmode="numeric" data-field="widthMm" data-id="${b.id}" value="${Number.isFinite(b.widthMm) ? b.widthMm : ""}" placeholder="e.g., 1000"></td>
        <td class="col-drop" data-label="Drop (mm)"><input inputmode="numeric" data-field="dropMm" data-id="${b.id}" value="${Number.isFinite(b.dropMm) ? b.dropMm : ""}" placeholder="e.g., 1200"></td>
        <td data-label="Material">
          ${materials.length ? `<select data-field="materialId" data-id="${b.id}">${options}</select>` : `<div class="err">No materials. Add one in Settings.</div>`}
        </td>
        <td data-label="Actions">
          <div class="actions">
            <button class="btn small" data-action="dup-blind" data-id="${b.id}" type="button">Duplicate</button>
            <button class="btn small danger" data-action="del-blind" data-id="${b.id}" type="button">Delete</button>
          </div>
          <div class="hint" style="margin-top:6px;">Row ${idx + 1}</div>
        </td>
        `;
            blindsTbody.appendChild(tr);
            const sel = tr.querySelector('select[data-field="materialId"]');
            if (sel) sel.value = b.materialId || materials[0]?.id || "";
          });
        };

        blindsTbody?.addEventListener("input", (e) => {
          const el = e.target;
          const id = el?.dataset?.id,
            field = el?.dataset?.field;
          if (!id || !field) return;
          const i = blinds.findIndex((b) => b.id === id);
          if (i < 0) return;

          if (field === "materialId") blinds[i].materialId = el.value;
          else if (field === "blindNo") {
            const cleaned = digitsOnly(el.value);
            if (el.value !== cleaned) el.value = cleaned;
            blinds[i].blindNo = cleaned;
          } else blinds[i][field] = toInt(el.value);

          save(KEYS.blinds, blinds);
        });

        blindsTbody?.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-action]");
          if (!btn) return;
          const action = btn.dataset.action,
            id = btn.dataset.id;
          const i = blinds.findIndex((b) => b.id === id);
          if (i < 0) return;

          if (action === "del-blind") {
            blinds.splice(i, 1);
            save(KEYS.blinds, blinds);
            $("#results").classList.add("hidden");
            renderJob();
            renderStatus();
            applyJobState();
          }
          if (action === "dup-blind") {
            const src = blinds[i];
            const defaultMat =
              src.materialId ||
              lastSelectedMaterialId() ||
              materials[0]?.id ||
              "";
            const proposed =
              blinds.length === 0
                ? 1
                : Number.isFinite(lastAddedBlindNo())
                  ? lastAddedBlindNo() + 1
                  : 1;

            blinds.push({
              id: uid(),
              blindNo: nextFreeBlindNo(proposed),
              widthMm: src.widthMm,
              dropMm: src.dropMm,
              materialId: src.materialId || defaultMat,
            });
            save(KEYS.blinds, blinds);
            $("#results").classList.add("hidden");
            renderJob();
            renderStatus();
            applyJobState();
          }
        });

        // Calculations
        const calcForBlind = (b) => {
          const material = materials.find((m) => m.id === b.materialId);
          const blindNo = (b.blindNo ?? "").trim();
          const width = toInt(b.widthMm),
            drop = toInt(b.dropMm);
          const issues = [];

          if (!Number.isFinite(width) || width <= 0)
            issues.push("Width is missing or invalid.");
          if (!Number.isFinite(drop) || drop <= 0)
            issues.push("Drop is missing or invalid.");
          if (!material) issues.push("Material is missing or invalid.");

          if (issues.length) return { issues, blindNo, width, drop, material };

          const mesh = toInt(material.meshMm),
            solid = toInt(material.solidMm),
            minus = toInt(material.l2MinusMm);
          const setLen = mesh + solid;

          const pole = width - 45;
          const totalLen = drop * 2 + 350;
          const l2 = drop - minus;

          if (pole <= 0) issues.push("Pole size is <= 0; check width.");
          if (l2 < 0) issues.push("L2 is negative; check drop or minus value.");

          const fullSets = setLen > 0 ? Math.floor(l2 / setLen) : NaN;
          const remainder = setLen > 0 ? l2 - fullSets * setLen : NaN;

          let within = "";
          if (Number.isFinite(remainder) && remainder >= 0) {
            if (remainder < mesh) within = `${remainder} mm into Mesh`;
            else if (remainder === mesh)
              within = "Exactly at Solid start (mesh boundary)";
            else within = `${remainder - mesh} mm into Solid`;
          }

          return {
            issues,
            blindNo,
            width,
            drop,
            pole,
            material,
            mesh,
            solid,
            minus,
            setLen,
            totalLen,
            l2,
            fullSets,
            remainder,
            within,
          };
        };

        const buildPrintMarkup = (rows) => {
          const title = job?.name ? esc(job.name) : "Job";
          const today = new Date();
          const dateStr = today.toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "2-digit",
          });

          const tr = rows
            .map(
              (r) => `
<tr>
  <td style="border:1px solid #000; padding:8px;">${esc(r.blindNo || "")}</td>
  <td style="border:1px solid #000; padding:8px;">
    ${r.material ? `${esc(r.material.name)}<br><span style="font-size:11px;">(${fmt(toInt(r.material.solidMm))} - ${fmt(toInt(r.material.meshMm))} - ${fmt(toInt(r.material.l2MinusMm))})</span>` : ""}
  </td>
  <td style="border:1px solid #000; padding:8px; text-align:right;">${fmt(r.width)}</td>
  <td style="border:1px solid #000; padding:8px; text-align:right;">${fmt(r.drop)}</td>
  <td style="border:1px solid #000; padding:8px; text-align:right;">${fmt(r.pole)}</td>
  <td style="border:1px solid #000; padding:8px; text-align:right;">${fmt(r.totalLen)}</td>
  <td style="border:1px solid #000; padding:8px;">${esc(r.within || "")}</td>
  <td style="border:1px solid #000; padding:8px; width:60px;"></td>
</tr>
`,
            )
            .join("");

          return `
<div style="font-family: Arial, Helvetica, sans-serif; color:#000; padding:24px;">
  <h1 style="font-size:18px; margin:0 0 6px;">${title}</h1>
  <div style="font-size:12px; margin:0 0 16px;">Printed: ${dateStr}</div>

  <table style="width:100%; border-collapse:collapse; font-size:12px;">
    <thead>
      <tr>
        <th style="border:1px solid #000; padding:8px; background:#f2f2f2; text-align:left;">Blind no.</th>
        <th style="border:1px solid #000; padding:8px; background:#f2f2f2; text-align:left;">Material</th>
        <th style="border:1px solid #000; padding:8px; background:#f2f2f2; text-align:right;">Width (mm)</th>
        <th style="border:1px solid #000; padding:8px; background:#f2f2f2; text-align:right;">Drop (mm)</th>
        <th style="border:1px solid #000; padding:8px; background:#f2f2f2; text-align:right;">Pole (mm)</th>
        <th style="border:1px solid #000; padding:8px; background:#f2f2f2; text-align:right;">Total fabric (mm)</th>
        <th style="border:1px solid #000; padding:8px; background:#f2f2f2; text-align:left;">Into set</th>
        <th style="border:1px solid #000; padding:8px; background:#f2f2f2; text-align:left;">Complete</th>
      </tr>
    </thead>
    <tbody>
      ${tr}
    </tbody>
  </table>
</div>
`;
        };

        const printResults = () => {
          const calculated = blinds.map(calcForBlind);
          const okRows = calculated.filter(
            (r) =>
              r.material &&
              !r.issues.some(
                (x) => x.includes("missing") || x.includes("invalid"),
              ),
          );

          if (!okRows.length) {
            alert(
              "Nothing to print yet. Please complete widths, drops, and materials.",
            );
            return;
          }

          const printArea = $("#print-area");
          if (!printArea) {
            alert("Print area not found.");
            return;
          }

          // Build and show the in-page print view.
          printArea.innerHTML = buildPrintMarkup(okRows);
          document.body.classList.add("printing");
          printArea.classList.remove("hidden");
          printArea.setAttribute("aria-hidden", "false");
          isPrinting = true;

          // IMPORTANT (mobile): call print synchronously from the click handler
          // to avoid losing the user gesture, which can be treated as “blocked”.
          try {
            // Force layout flush so Safari has the print DOM fully realized.
            void printArea.offsetHeight;
            window.print();
          } catch (err) {
            // If print fails, revert immediately.
            isPrinting = false;
            document.body.classList.remove("printing");
            printArea.classList.add("hidden");
            printArea.setAttribute("aria-hidden", "true");
            printArea.innerHTML = "";
            alert("Printing failed. Please try again in Safari.");
          }
        };

        const cleanupPrintView = () => {
          const printArea = $("#print-area");

          // If already cleaned up, nothing to do.
          if (!document.body.classList.contains("printing")) {
            isPrinting = false;
            if (printArea) {
              printArea.classList.add("hidden");
              printArea.setAttribute("aria-hidden", "true");
            }
            return;
          }

          // Mark as no longer printing immediately so multiple signals don't re-run.
          isPrinting = false;

          // Delay removing the print layout to avoid iOS blank previews when it re-snapshots
          // during printer/option selection.
          setTimeout(() => {
            document.body.classList.remove("printing");
            if (printArea) {
              printArea.classList.add("hidden");
              printArea.setAttribute("aria-hidden", "true");
              // IMPORTANT: do NOT clear innerHTML here (prevents blank rescans on iOS).
            }
          }, 1500);
        };

        // Detect print end signals. iOS Safari can misfire afterprint early, so we prefer
        // matchMedia('print') + visibility/focus when returning to the page.
        const printMql = window.matchMedia ? window.matchMedia("print") : null;

        if (printMql) {
          const onPrintChange = (e) => {
            // When leaving print mode, clean up.
            if (!e.matches) cleanupPrintView();
          };
          // Safari versions vary on API support
          if (printMql.addEventListener)
            printMql.addEventListener("change", onPrintChange);
          else if (printMql.addListener) printMql.addListener(onPrintChange);
        }

        // When the print UI is dismissed, the page generally regains focus/visibility.
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") cleanupPrintView();
        });
        window.addEventListener("focus", () => cleanupPrintView());

        // Fallback: if a browser fails to fire print-end signals, any tap after returning
        // will restore the app layout.
        document.addEventListener(
          "pointerdown",
          () => {
            if (document.body.classList.contains("printing"))
              cleanupPrintView();
          },
          { passive: true },
        );

        const renderResults = () => {
          const resWrap = $("#results");
          resWrap.innerHTML = "";

          if (!job || !blinds.length) {
            resWrap.classList.add("hidden");
            return;
          }
          if (!materials.length) {
            resWrap.classList.remove("hidden");
            resWrap.innerHTML = `<div class="result-card"><div class="warn">Add at least one material in Settings to calculate.</div></div>`;
            return;
          }

          const results = blinds.map(calcForBlind);

          results.forEach((r, idx) => {
            const title = r.blindNo
              ? `Blind No. ${esc(r.blindNo)}`
              : `Blind ${idx + 1}`;
            const matName = r.material ? r.material.name : "—";
            const meta = `Width ${fmt(r.width)} • Drop ${fmt(r.drop)} • Material: ${esc(matName)}`;
            const warnHtml = r.issues.length
              ? `<div class="warn">${r.issues.map(esc).join(" ")}</div>`
              : "";

            const card = document.createElement("div");
            card.className = "result-card";

            if (!r.material) {
              card.innerHTML = `<div class="result-top"><div><h3>${esc(title)}</h3><div class="result-meta">${meta}</div></div></div>${warnHtml}`;
              resWrap.appendChild(card);
              return;
            }

            card.innerHTML = `
        <div class="result-top">
          <div><h3>${esc(title)}</h3><div class="result-meta">${meta}</div></div>
          <div class="pill"><strong>Set ${fmt(r.setLen)}</strong><span class="subpill">Mesh ${fmt(r.mesh)} / Solid ${fmt(r.solid)}</span></div>
        </div>
        <div class="kv">
          <div class="k"><div class="lbl">Pole size</div><div class="val">${fmt(r.pole)} <small>mm</small></div></div>
          <div class="k"><div class="lbl">Total fabric length</div><div class="val">${fmt(r.totalLen)} <small>mm</small></div></div>
          <div class="k"><div class="lbl">L2 cut</div><div class="val">${fmt(r.l2)} <small>mm</small></div></div>
          <div class="k"><div class="lbl">Full sets in L2</div><div class="val">${Number.isFinite(r.fullSets) ? r.fullSets : "—"} <small>sets</small>${Number.isFinite(r.fullSets) && Number.isFinite(r.setLen) ? ` <span class="muted" style="font-size:12px;font-weight:800;">(${fmt(r.fullSets * r.setLen)})</span>` : ""}</div></div>
          <div class="k wide"><div class="lbl">Where L2 falls within a set (remainder)</div><div class="val">${fmt(r.remainder)} <small>mm</small> <span class="muted" style="font-size:12px;font-weight:800;">${esc(r.within || "")}</span></div></div>
          <div class="k wide"><div class="lbl">Formula snapshot</div>
            <div class="val" style="font-size:12px;font-weight:800;font-family:var(--mono);">
              Pole = width−45; Total = drop×2+350; L2 = drop−${fmt(r.minus)}; remainder = L2 mod ${fmt(r.setLen)}
            </div>
          </div>
        </div>
        ${warnHtml}
      `;
            resWrap.appendChild(card);
          });

          const footer = document.createElement("div");
          footer.className = "result-card";
          footer.style.gridColumn = "span 12";
          footer.style.marginTop = "14px";
          footer.innerHTML = `
      <div class="card-hd">
        <h3>Print</h3>
        <span class="pill">Black &amp; white</span>
      </div>
      <div class="card-bd">
        <div class="row">
          <button class="btn primary" id="btn-print" type="button">Print results</button>
          <span class="hint">Prints a simple table with the job title and a blank “Complete” column.</span>
        </div>
      </div>
    `;
          resWrap.appendChild(footer);
          $("#btn-print").addEventListener("click", printResults);

          resWrap.classList.remove("hidden");
          resWrap.scrollIntoView({ behavior: "smooth", block: "start" });
        };

        $("#btn-calc")?.addEventListener("click", () => {
          if (!job) {
            alert("Create a job first.");
            return;
          }
          if (!materials.length) {
            alert("Add at least one material in Settings first.");
            setTab("settings");
            return;
          }
          renderResults();
        });

        // Initial
        renderMaterials();
        renderJob();
        renderStatus();
        applyJobState();
        setMatFormMode("new");
        if (!materials.length) setTab("settings");
        else setTab("job");
      })();
    </script>
  </body>
</html>
